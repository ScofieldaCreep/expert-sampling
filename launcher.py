import base64
import os
import sys
import tempfile
from pathlib import Path

# 在构建时由脚本替换为真实Base64内容
APP_CODE_B64 = "aW1wb3J0IGlvCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBPcHRpb25hbCwgVHVwbGUKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBzdHJlYW1saXQgYXMgc3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBzdHJlYW1saXQuY29tcG9uZW50cy52MSBpbXBvcnQgaHRtbCBhcyBzdF9odG1sCgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0g6aG16Z2i5LiO5bi46YePIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpzdC5zZXRfcGFnZV9jb25maWcocGFnZV90aXRsZT0i5LiT5a625oq95qC35Yqp5omLIiwgcGFnZV9pY29uPSLwn46vIiwgbGF5b3V0PSJ3aWRlIikKClJFUVVJUkVEX0ZJRUxEU19DTiA9IHsKICAgICJuYW1lIjogIuWnk+WQjSIsCiAgICAibWFqb3IiOiAi5LiT5LiaIiwKICAgICJwaG9uZSI6ICLmiYvmnLrlj7ciLAogICAgInRpdGxlIjogIuiBjOensCIsCiAgICAiZW1haWwiOiAi6YKu566xIiwKfQoKUE9TU0lCTEVfQ09MVU1OX0FMSUFTRVM6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0gewogICAgIm5hbWUiOiBbIuWnk+WQjSIsICLlkI3lrZciLCAiTmFtZSIsICLlp5PlkI0vTmFtZSIsICLlkZjlt6Xlp5PlkI0iXSwKICAgICJtYWpvciI6IFsi5LiT5LiaIiwgIuS4k+S4muaWueWQkSIsICJNYWpvciIsICLlrabnp5EiLCAi6aKG5Z+fIl0sCiAgICAicGhvbmUiOiBbIuaJi+acuuWPtyIsICLmiYvmnLoiLCAi55S16K+dIiwgIuiBlOezu+eUteivnSIsICJQaG9uZSIsICJNb2JpbGUiLCAi5omL5py65Y+356CBIiwgIuiBlOezu+aJi+acuiJdLAogICAgInRpdGxlIjogWyLogYznp7AiLCAi5oqA5pyv6IGM56ewIiwgIlRpdGxlIiwgIuWyl+S9jSIsICLlspfkvY0v6IGM56ewIl0sCiAgICAiZW1haWwiOiBbIumCrueusSIsICLnlLXlrZDpgq7nrrEiLCAiRW1haWwiLCAiRS1tYWlsIl0sCn0KCiMg5Y+v6YCJ5a2X5q6177yM55So5LqO5Lu/5Yi255WM6Z2i5pu05aSa562b6YCJL+WxleekugpPUFRJT05BTF9BTElBU0VTOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHsKICAgICJnZW5kZXIiOiBbIuaAp+WIqyIsICJHZW5kZXIiXSwKICAgICJiaXJ0aCI6IFsi5Ye655Sf5bm05pyIIiwgIuWHuueUn+aXpeacnyIsICLlh7rnlJ8iLCAi55Sf5pelIl0sCiAgICAiaWRjYXJkIjogWyLouqvku73or4Hlj7ciLCAi6Lqr5Lu96K+B5Y+356CBIiwgIuivgeS7tuWPt+eggSJdLAogICAgIm9yZyI6IFsi5L6b6IGM5Y2V5L2NIiwgIuWNleS9jSIsICLlt6XkvZzljZXkvY0iLCAi5omA5Zyo5Y2V5L2NIl0sCiAgICAicG9zaXRpb24iOiBbIuiBjOWKoSIsICLlspfkvY0iLCAi6IGM5L2NIl0sCiAgICAiZGVncmVlIjogWyLlrabljoYiLCAi5pyA6auY5a2m5Y6GIl0sCiAgICAicXVhbGlmaWNhdGlvbiI6IFsi5rOo5YaM6LWE5qC8IiwgIui1hOagvCIsICLms6jlhozor4HkuaYiXSwKICAgICJjb250YWN0IjogWyLogZTns7vmlrnlvI8iLCAi6IGU57O755S16K+dIiwgIuiBlOezu+aJi+acuiIsICLmiYvmnLrlj7fnoIEiLCAi5omL5py65Y+3IiwgIueUteivnSJdLAogICAgImNvbnRhY3RfcmVzdWx0IjogWyLogZTns7vnu5PmnpwiLCAi5Zue6K6/57uT5p6cIl0sCn0KClNVUFBPUlRFRF9FWFRFTlNJT05TID0gWyIueGxzeCIsICIueGxzIiwgIi5jc3YiXQoKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIOW3peWFt+WHveaVsCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQHN0LmNhY2hlX2RhdGEoc2hvd19zcGlubmVyPUZhbHNlKQpkZWYgbG9hZF9kYXRhZnJhbWUoZmlsZV9ieXRlczogYnl0ZXMsIGZpbGVuYW1lOiBzdHIpIC0+IHBkLkRhdGFGcmFtZToKICAgIGZpbGVuYW1lX2xvd2VyID0gZmlsZW5hbWUubG93ZXIoKQogICAgaWYgZmlsZW5hbWVfbG93ZXIuZW5kc3dpdGgoIi5jc3YiKToKICAgICAgICAjIOiHquWKqOWwneivleW4uOingee8lueggQogICAgICAgIGZvciBlbmMgaW4gWyJ1dGYtOCIsICJnYmsiLCAiZ2IyMzEyIiwgInV0Zi04LXNpZyJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4gcGQucmVhZF9jc3YoaW8uQnl0ZXNJTyhmaWxlX2J5dGVzKSwgZW5jb2Rpbmc9ZW5jKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICByZXR1cm4gcGQucmVhZF9jc3YoaW8uQnl0ZXNJTyhmaWxlX2J5dGVzKSkKICAgIGVsaWYgZmlsZW5hbWVfbG93ZXIuZW5kc3dpdGgoIi54bHMiKToKICAgICAgICByZXR1cm4gcGQucmVhZF9leGNlbChpby5CeXRlc0lPKGZpbGVfYnl0ZXMpLCBlbmdpbmU9InhscmQiKQogICAgZWxzZToKICAgICAgICByZXR1cm4gcGQucmVhZF9leGNlbChpby5CeXRlc0lPKGZpbGVfYnl0ZXMpLCBlbmdpbmU9Im9wZW5weXhsIikKCgpkZWYgbm9ybWFsaXplX2NvbHVtbnMoZGY6IHBkLkRhdGFGcmFtZSkgLT4gcGQuRGF0YUZyYW1lOgogICAgbmV3X2RmID0gZGYuY29weSgpCiAgICBuZXdfZGYuY29sdW1ucyA9IFtzdHIoYykuc3RyaXAoKSBmb3IgYyBpbiBuZXdfZGYuY29sdW1uc10KICAgIHJldHVybiBuZXdfZGYKCgpkZWYgX2lzX2VtcHR5X3ZhbHVlKHY6IG9iamVjdCkgLT4gYm9vbDoKICAgIHMgPSBzdHIodikuc3RyaXAoKQogICAgcmV0dXJuIHMgPT0gIiIgb3Igcy5sb3dlcigpIGluIHsibmFuIiwgIm5vbmUiLCAibnVsbCJ9CgoKZGVmIGF1dG9fbG9jYXRlX2hlYWRlcl9ieV9rZXl3b3JkKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuagueaNruWMheWQq+KAnOW6j+WPt+KAneetieWFs+mUruivjeeahOihjOiHquWKqOWumuS9jeihqOWktOOAggogICAg562W55Wl77ya6KGM5Lit5YyF5ZCr4oCc5bqP5Y+34oCd77yM5LiU5LiO5bi46KeB6KGo5aS05YWz6ZSu6K+N5Lqk6ZuGPj0z77yM5YiZ6K+l6KGM5Li66KGo5aS077ybCiAgICDku6Xor6XooYzkuYvkuIvkuIDooYzkuLrmlbDmja7lvIDlp4vvvJvlsIbor6XooYzotYvkuLrliJflkI3jgIIKICAgICIiIgogICAgaWYgZGYuZW1wdHk6CiAgICAgICAgcmV0dXJuIGRmCiAgICBzID0gZGYuYXN0eXBlKHN0cikuYXBwbHltYXAobGFtYmRhIHg6IHN0cih4KS5zdHJpcCgpKQogICAgaGVhZGVyX2tleXdvcmRzID0geyLluo/lj7ciLCAi5aeT5ZCNIiwgIuaAp+WIqyIsICLlh7rnlJ/lubTmnIgiLCAi6Lqr5Lu96K+B5Y+3IiwgIuS4k+S4miIsICLmiYvmnLrlj7fnoIEiLCAi5omL5py65Y+3IiwgIuS+m+iBjOWNleS9jSIsICLljZXkvY0iLCAi6IGM56ewIiwgIuiBjOWKoSIsICLnlLXlrZDpgq7nrrEiLCAi6YKu566xIiwgIuWkh+azqCJ9CiAgICBoZWFkZXJfcm93X2lkeDogT3B0aW9uYWxbaW50XSA9IE5vbmUKICAgIGZvciBpLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHZhbHMgPSBbdiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KV0KICAgICAgICBpZiBub3QgdmFsczoKICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiAi5bqP5Y+3IiBpbiB2YWxzOgogICAgICAgICAgICBpZiBsZW4oc2V0KHZhbHMpICYgaGVhZGVyX2tleXdvcmRzKSA+PSAzOgogICAgICAgICAgICAgICAgaGVhZGVyX3Jvd19pZHggPSBpCiAgICAgICAgICAgICAgICBicmVhawogICAgaWYgaGVhZGVyX3Jvd19pZHggaXMgTm9uZToKICAgICAgICByZXR1cm4gZGYKICAgIGNvbHVtbnMgPSBzLmlsb2NbaGVhZGVyX3Jvd19pZHhdLnRvbGlzdCgpCiAgICBjb2x1bW5zID0gW2MgaWYgbm90IF9pc19lbXB0eV92YWx1ZShjKSBlbHNlIGYi5YiXe2orMX0iIGZvciBqLCBjIGluIGVudW1lcmF0ZShjb2x1bW5zKV0KICAgIGJvZHkgPSBkZi5pbG9jW2hlYWRlcl9yb3dfaWR4ICsgMSA6XS5jb3B5KCkKICAgIGJvZHkuY29sdW1ucyA9IGNvbHVtbnMKICAgIHJldHVybiBub3JtYWxpemVfY29sdW1ucyhib2R5KQoKCmRlZiBkcm9wX2dyb3VwX2hlYWRlcl9yb3dzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuWIoOmZpOS7heWMheWQq+S4gOS4qumdnuepuuaWh+acrO+8jOS4lOivpeaWh+acrOeWkeS8vOWIhue7hOagh+mimOeahOihjO+8jOS+i+WmguKAnOS/oeaBr+WMluS4k+S4muKAneOAggogICAg5Yik5a6a6KeE5YiZ77yaCiAgICAtIOihjOWGhemdnuepuuWNleWFg+agvOaVsOmHjzw9Mu+8jOS4lAogICAgLSDlrZjlnKjpnZ7nqbrlgLzmu6HotrPvvJrnrYnkuo7igJzkv6Hmga/ljJbkuJPkuJrigJ3miJbku6XigJzkuJPkuJrigJ3nu5PlsL7miJbku6XigJznsbvliKvigJ3nu5PlsL4KICAgICIiIgogICAgaWYgZGYuZW1wdHk6CiAgICAgICAgcmV0dXJuIGRmCiAgICBzID0gZGYuYXN0eXBlKHN0cikuYXBwbHltYXAobGFtYmRhIHg6IHN0cih4KS5zdHJpcCgpKQogICAgbWFza19kcm9wID0gW10KICAgIGZvciBfLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHZhbHMgPSBbdiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KV0KICAgICAgICBpZiBsZW4odmFscykgPD0gMjoKICAgICAgICAgICAgY2FuZGlkYXRlID0gIiIuam9pbih2YWxzKQogICAgICAgICAgICBjYW5kaWRhdGUgPSBjYW5kaWRhdGUucmVwbGFjZSgiICIsICIiKQogICAgICAgICAgICBpZiBjYW5kaWRhdGUgaW4geyLkv6Hmga/ljJbkuJPkuJoifSBvciBjYW5kaWRhdGUuZW5kc3dpdGgoIuS4k+S4miIpIG9yIGNhbmRpZGF0ZS5lbmRzd2l0aCgi57G75YirIik6CiAgICAgICAgICAgICAgICBtYXNrX2Ryb3AuYXBwZW5kKFRydWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIG1hc2tfZHJvcC5hcHBlbmQoRmFsc2UpCiAgICByZXR1cm4gZGYubG9jW1tub3QgeCBmb3IgeCBpbiBtYXNrX2Ryb3BdXQoKCmRlZiBkcm9wX2VtYmVkZGVkX2hlYWRlcl9yb3dzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuWIoOmZpOihqOWGhemHjeWkjeeahOihqOWktOihjO+8iOS+i+WmguWIhumhteWQjuWPiOWHuueOsOS4gOasoeKAmOWnk+WQjS/kuJPkuJov6IGM56ewLy4uLuKAme+8ieOAggogICAg6KeE5YiZ77ya5aaC5p6c5pys6KGM5ZCr5pyJ6Iez5bCRM+S4quWtl+auteWQjeWFs+mUruWtl++8jOWImeWIpOWumuS4uuihqOWktOihjOOAggogICAgIiIiCiAgICBpZiBkZi5lbXB0eToKICAgICAgICByZXR1cm4gZGYKICAgIGhlYWRlcl9rZXl3b3JkcyA9IHNldChSRVFVSVJFRF9GSUVMRFNfQ04udmFsdWVzKCkpIHwgeyLmgKfliKsiLCAi5Ye655Sf5bm05pyIIiwgIui6q+S7veivgeWPtyIsICLljZXkvY0iLCAi5L6b6IGM5Y2V5L2NIiwgIuiBjOWKoSIsICLnlLXlrZDpgq7nrrEiLCAi5aSH5rOoIn0KICAgIHMgPSBkZi5hc3R5cGUoc3RyKS5hcHBseW1hcChsYW1iZGEgeDogc3RyKHgpLnN0cmlwKCkpCiAgICBrZWVwX2ZsYWdzOiBMaXN0W2Jvb2xdID0gW10KICAgIGZvciBfLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHJvd19zZXQgPSBzZXQodiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KSkKICAgICAgICBpbnRlcnNlY3RfY250ID0gbGVuKHJvd19zZXQgJiBoZWFkZXJfa2V5d29yZHMpCiAgICAgICAga2VlcF9mbGFncy5hcHBlbmQoaW50ZXJzZWN0X2NudCA8IDMpCiAgICByZXR1cm4gZGYubG9jW2tlZXBfZmxhZ3NdCgoKZGVmIF9maW5kX2ZpcnN0X21hdGNoKGRmOiBwZC5EYXRhRnJhbWUsIGFsaWFzZXM6IExpc3Rbc3RyXSkgLT4gT3B0aW9uYWxbc3RyXToKICAgIGNvbHMgPSBsaXN0KGRmLmNvbHVtbnMpCiAgICBjb2xzX2xjID0ge2M6IHN0cihjKS5sb3dlcigpIGZvciBjIGluIGNvbHN9CiAgICBmb3IgYSBpbiBhbGlhc2VzOgogICAgICAgICMg57K+56GuCiAgICAgICAgZm9yIGMgaW4gY29sczoKICAgICAgICAgICAgaWYgc3RyKGMpLnN0cmlwKCkgPT0gYToKICAgICAgICAgICAgICAgIHJldHVybiBjCiAgICAgICAgIyDmqKHns4rljIXlkKsKICAgICAgICBhX2xjID0gYS5sb3dlcigpCiAgICAgICAgZm9yIGMsIGNfbGMgaW4gY29sc19sYy5pdGVtcygpOgogICAgICAgICAgICBpZiBhX2xjIGluIGNfbGM6CiAgICAgICAgICAgICAgICByZXR1cm4gYwogICAgcmV0dXJuIE5vbmUKCgpkZWYgZ3Vlc3NfbWFwcGluZyhkZjogcGQuRGF0YUZyYW1lKSAtPiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV06CiAgICBtYXBwaW5nOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0gPSB7azogTm9uZSBmb3IgayBpbiBSRVFVSVJFRF9GSUVMRFNfQ04ua2V5cygpfQoKICAgIGZvciBmaWVsZCwgYWxpYXNlcyBpbiBQT1NTSUJMRV9DT0xVTU5fQUxJQVNFUy5pdGVtcygpOgogICAgICAgIGNvbCA9IF9maW5kX2ZpcnN0X21hdGNoKGRmLCBhbGlhc2VzKQogICAgICAgIGlmIGNvbCBpcyBub3QgTm9uZToKICAgICAgICAgICAgbWFwcGluZ1tmaWVsZF0gPSBjb2wKICAgIHJldHVybiBtYXBwaW5nCgoKZGVmIGJ1aWxkX21hcHBlZF9kZihkZjogcGQuRGF0YUZyYW1lLCBtYXBwaW5nOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0pIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgTGlzdFtzdHJdXToKICAgIGVycm9yczogTGlzdFtzdHJdID0gW10KICAgIHNlbGVjdGVkX2NvbHMgPSB7fQogICAgZm9yIGtleSwgY24gaW4gUkVRVUlSRURfRklFTERTX0NOLml0ZW1zKCk6CiAgICAgICAgY29sID0gbWFwcGluZy5nZXQoa2V5KQogICAgICAgIGlmIGNvbCBpcyBOb25lOgogICAgICAgICAgICBlcnJvcnMuYXBwZW5kKGYi5pyq6YCJ5oup5a2X5q6177yae2NufSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZWN0ZWRfY29sc1tjbl0gPSBkZltjb2xdCiAgICBpZiBlcnJvcnM6CiAgICAgICAgcmV0dXJuIHBkLkRhdGFGcmFtZSgpLCBlcnJvcnMKCiAgICByZXN1bHQgPSBwZC5EYXRhRnJhbWUoc2VsZWN0ZWRfY29scykKCiAgICAjIOi9u+W6pua4hea0lwogICAgZm9yIGMgaW4gcmVzdWx0LmNvbHVtbnM6CiAgICAgICAgcmVzdWx0W2NdID0gcmVzdWx0W2NdLmFzdHlwZShzdHIpLnN0ci5zdHJpcCgpLnJlcGxhY2UoeyJuYW4iOiAiIiwgIk5vbmUiOiAiIiwgIm51bGwiOiAiIiwgIk5hTiI6ICIifSkKCiAgICAjIOaJi+acuuWPt+S7heS/neeVmeaVsOWtlwogICAgcmVzdWx0W1JFUVVJUkVEX0ZJRUxEU19DTlsicGhvbmUiXV0gPSAoCiAgICAgICAgcmVzdWx0W1JFUVVJUkVEX0ZJRUxEU19DTlsicGhvbmUiXV0KICAgICAgICAuc3RyLnJlcGxhY2UociJbXjAtOV0iLCAiIiwgcmVnZXg9VHJ1ZSkKICAgICAgICAuc3RyLnNsaWNlKDAsIDIwKQogICAgKQoKICAgICMg5Yig6Zmk55aR5Ly85qCH6aKYL+WIhumalOihjO+8iOaYoOWwhOWQjuWGjeWFnOW6leS4gOasoe+8iQogICAgbmFtZV9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibmFtZSJdCiAgICBtYWpvcl9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgdGl0bGVfY24gPSBSRVFVSVJFRF9GSUVMRFNfQ05bInRpdGxlIl0KICAgIG1hc2sgPSB+KAogICAgICAgIChyZXN1bHRbbmFtZV9jbl0uZXEoIiIpICYgKHJlc3VsdFtbbWFqb3JfY24sIHRpdGxlX2NuXV0ucmVwbGFjZSgiIiwgcGQuTkEpLm5vdG5hKCkuc3VtKGF4aXM9MSkgPD0gMSkpCiAgICAgICAgfCAocmVzdWx0W25hbWVfY25dLmlzaW4oWyLlp5PlkI0iLCAi5L+h5oGv5YyW5LiT5LiaIl0pKQogICAgICAgIHwgKHJlc3VsdFttYWpvcl9jbl0uaXNpbihbIuS/oeaBr+WMluS4k+S4miJdKSkKICAgICkKICAgIHJlc3VsdCA9IHJlc3VsdC5sb2NbbWFza10KCiAgICByZXR1cm4gcmVzdWx0LCBbXQoKCmRlZiBkZXNjcmliZV9kYXRhZnJhbWUoZGY6IHBkLkRhdGFGcmFtZSwgbWFwcGVkX2RmOiBPcHRpb25hbFtwZC5EYXRhRnJhbWVdID0gTm9uZSkgLT4gRGljdFtzdHIsIG9iamVjdF06CiAgICBzdW1tYXJ5ID0gewogICAgICAgICLooYzmlbAiOiBpbnQoZGYuc2hhcGVbMF0pLAogICAgICAgICLliJfmlbAiOiBpbnQoZGYuc2hhcGVbMV0pLAogICAgICAgICLliJflkI0iOiBsaXN0KG1hcChzdHIsIGRmLmNvbHVtbnMpKSwKICAgIH0KICAgIGlmIG1hcHBlZF9kZiBpcyBub3QgTm9uZSBhbmQgbm90IG1hcHBlZF9kZi5lbXB0eToKICAgICAgICBtYWpvciA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgICAgIHRpdGxlID0gUkVRVUlSRURfRklFTERTX0NOWyJ0aXRsZSJdCiAgICAgICAgc3VtbWFyeS51cGRhdGUoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGYi5ZSv5LiAe21ham9yfeaVsCI6IGludChtYXBwZWRfZGZbbWFqb3JdLnJlcGxhY2UoIiIsIHBkLk5BKS5udW5pcXVlKGRyb3BuYT1UcnVlKSksCiAgICAgICAgICAgICAgICBmIuWUr+S4gHt0aXRsZX3mlbAiOiBpbnQobWFwcGVkX2RmW3RpdGxlXS5yZXBsYWNlKCIiLCBwZC5OQSkubnVuaXF1ZShkcm9wbmE9VHJ1ZSkpLAogICAgICAgICAgICAgICAgIue8uuWksee7n+iuoSI6IG1hcHBlZF9kZi5yZXBsYWNlKCIiLCBwZC5OQSkuaXNuYSgpLnN1bSgpLnRvX2RpY3QoKSwKICAgICAgICAgICAgfQogICAgICAgICkKICAgIHJldHVybiBzdW1tYXJ5CgoKZGVmIGNvbXB1dGVfc2FtcGxlX3NpemUodG90YWw6IGludCwgbW9kZTogc3RyLCBjb3VudDogaW50LCBwZXJjZW50OiBmbG9hdCkgLT4gaW50OgogICAgaWYgdG90YWwgPD0gMDoKICAgICAgICByZXR1cm4gMAogICAgaWYgbW9kZSA9PSAi5oyJ5pWw6YePIjoKICAgICAgICByZXR1cm4gaW50KG1heCgwLCBtaW4odG90YWwsIGNvdW50KSkpCiAgICAjIOaMieeZvuWIhuavlAogICAgbiA9IGludChucC5mbG9vcih0b3RhbCAqIChwZXJjZW50IC8gMTAwLjApKSkKICAgIHJldHVybiBtYXgoMSBpZiB0b3RhbCA+IDAgZWxzZSAwLCBtaW4odG90YWwsIG4pKQoKCmRlZiBzYW1wbGVfcm93cyhkZjogcGQuRGF0YUZyYW1lLCBzYW1wbGVfc2l6ZTogaW50LCBzZWVkOiBPcHRpb25hbFtpbnRdKSAtPiBwZC5EYXRhRnJhbWU6CiAgICBpZiBzYW1wbGVfc2l6ZSA8PSAwIG9yIGRmLmVtcHR5OgogICAgICAgIHJldHVybiBkZi5pbG9jWzA6MF0KICAgIHJuZyA9IG5wLnJhbmRvbS5kZWZhdWx0X3JuZyhOb25lIGlmIHNlZWQgaW4gKE5vbmUsICIiKSBlbHNlIGludChzZWVkKSkKICAgIGlkeCA9IHJuZy5jaG9pY2UoZGYuaW5kZXgudmFsdWVzLCBzaXplPXNhbXBsZV9zaXplLCByZXBsYWNlPUZhbHNlKQogICAgcmV0dXJuIGRmLmxvY1tpZHhdCgoKZGVmIHRvX2V4Y2VsX2J5dGVzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IGJ5dGVzOgogICAgYnVmID0gaW8uQnl0ZXNJTygpCiAgICB3aXRoIHBkLkV4Y2VsV3JpdGVyKGJ1ZiwgZW5naW5lPSJvcGVucHl4bCIpIGFzIHdyaXRlcjoKICAgICAgICBkZi50b19leGNlbCh3cml0ZXIsIGluZGV4PUZhbHNlKQogICAgYnVmLnNlZWsoMCkKICAgIHJldHVybiBidWYucmVhZCgpCgoKZGVmIGRldGVjdF9vcHRpb25hbF9jb2x1bW5zKGRmOiBwZC5EYXRhRnJhbWUpIC0+IERpY3Rbc3RyLCBPcHRpb25hbFtzdHJdXToKICAgIGZvdW5kOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0gPSB7fQogICAgZm9yIGssIGFsaWFzZXMgaW4gT1BUSU9OQUxfQUxJQVNFUy5pdGVtcygpOgogICAgICAgIGZvdW5kW2tdID0gX2ZpbmRfZmlyc3RfbWF0Y2goZGYsIGFsaWFzZXMpCiAgICByZXR1cm4gZm91bmQKCgpkZWYgY29tcHV0ZV9hZ2Vfc2VyaWVzKGJpcnRoX3NlcmllczogcGQuU2VyaWVzKSAtPiBwZC5TZXJpZXM6CiAgICBkdCA9IHBkLnRvX2RhdGV0aW1lKGJpcnRoX3NlcmllcywgZXJyb3JzPSJjb2VyY2UiKQogICAgdG9kYXkgPSBwZC5UaW1lc3RhbXAudG9kYXkoKS5ub3JtYWxpemUoKQogICAgYWdlID0gKHRvZGF5IC0gZHQpLmR0LmRheXMgLy8gMzY1CiAgICByZXR1cm4gYWdlCgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0g5bqU55So5Li75L2TIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpkZWYgbWFpbigpIC0+IE5vbmU6CiAgICBzdC50aXRsZSgi8J+OryDkuJPlrrbmir3moLfliqnmiYsiKQogICAgc3QuY2FwdGlvbigi5LiK5Lyg5LiT5a625bqT77yIRXhjZWwvQ1NW77yJ77yM6Ieq5Yqo5a6a5L2N6KGo5aS0IOKGkiDmuIXmtJcg4oaSIOaYoOWwhCDihpIg562b6YCJL+aKveagtyDihpIg5a+85Ye6IikKCiAgICB1cGxvYWRlZCA9IHN0LmZpbGVfdXBsb2FkZXIoCiAgICAgICAgbGFiZWw9IuS4iuS8oOaWh+S7tiAo5pSv5oyBIC54bHN4Ly54bHMvLmNzdikiLAogICAgICAgIHR5cGU9WyJ4bHN4IiwgInhscyIsICJjc3YiXSwKICAgICAgICBhY2NlcHRfbXVsdGlwbGVfZmlsZXM9RmFsc2UsCiAgICApCgogICAgaWYgbm90IHVwbG9hZGVkOgogICAgICAgIHN0LmluZm8oIuivt+WFiOS4iuS8oOaWh+S7tuOAguaUr+aMgSBFeGNlbCDmiJYgQ1NW44CCIikKICAgICAgICBzdC5zdG9wKCkKCiAgICB0cnk6CiAgICAgICAgcmF3X2RmID0gbG9hZF9kYXRhZnJhbWUodXBsb2FkZWQuZ2V0dmFsdWUoKSwgdXBsb2FkZWQubmFtZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBzdC5lcnJvcihmIuivu+WPluaWh+S7tuWksei0pe+8mntlfSIpCiAgICAgICAgc3Quc3RvcCgpCgogICAgIyDoh6rliqjlrprkvY3ooajlpLTooYzvvIjln7rkuo7igJzluo/lj7figJ3nrYnlhbPplK7lrZfvvIkKICAgIGRmID0gYXV0b19sb2NhdGVfaGVhZGVyX2J5X2tleXdvcmQocmF3X2RmKQogICAgIyDop4TojIPliJflkI0gKyDmuIXmtJfmnYLpobnooYwKICAgIGRmID0gbm9ybWFsaXplX2NvbHVtbnMoZGYpCiAgICBkZiA9IGRyb3BfZ3JvdXBfaGVhZGVyX3Jvd3MoZGYpCiAgICBkZiA9IGRyb3BfZW1iZWRkZWRfaGVhZGVyX3Jvd3MoZGYpCgogICAgc3Quc3ViaGVhZGVyKCLmlbDmja7pooTop4jvvIjoh6rliqjlrprkvY3ooajlpLQgKyDmuIXmtJflkI7vvIkiKQogICAgc3QuZGF0YWZyYW1lKGRmLmhlYWQoNTApLCB1c2VfY29udGFpbmVyX3dpZHRoPVRydWUpCgogICAgIyDlrZfmrrXmmKDlsITvvIjlv4XloavvvIkKICAgIHN0LnN1YmhlYWRlcigi5a2X5q615pig5bCEIikKICAgIGRlZmF1bHRfbWFwcGluZyA9IGd1ZXNzX21hcHBpbmcoZGYpCgogICAgbWFwcGluZzogRGljdFtzdHIsIE9wdGlvbmFsW3N0cl1dID0ge30KICAgIGNvbHMgPSBzdC5jb2x1bW5zKDUpCiAgICBmb3IgaSwgKGtleSwgY24pIGluIGVudW1lcmF0ZShSRVFVSVJFRF9GSUVMRFNfQ04uaXRlbXMoKSk6CiAgICAgICAgd2l0aCBjb2xzW2kgJSA1XToKICAgICAgICAgICAgbWFwcGluZ1trZXldID0gc3Quc2VsZWN0Ym94KAogICAgICAgICAgICAgICAgbGFiZWw9ZiJ7Y259IOWtl+autSIsCiAgICAgICAgICAgICAgICBvcHRpb25zPVtOb25lXSArIGxpc3QoZGYuY29sdW1ucyksCiAgICAgICAgICAgICAgICBpbmRleD0oCiAgICAgICAgICAgICAgICAgICAgW05vbmVdICsgbGlzdChkZi5jb2x1bW5zKQogICAgICAgICAgICAgICAgKS5pbmRleChkZWZhdWx0X21hcHBpbmcuZ2V0KGtleSkpIGlmIGRlZmF1bHRfbWFwcGluZy5nZXQoa2V5KSBpbiBkZi5jb2x1bW5zIGVsc2UgMCwKICAgICAgICAgICAgICAgIGZvcm1hdF9mdW5jPWxhbWJkYSB4OiAi5pyq6YCJ5oupIiBpZiB4IGlzIE5vbmUgZWxzZSBzdHIoeCksCiAgICAgICAgICAgICkKCiAgICBtYXBwZWRfZGYsIGVycm9ycyA9IGJ1aWxkX21hcHBlZF9kZihkZiwgbWFwcGluZykKICAgIGlmIGVycm9yczoKICAgICAgICBzdC53YXJuaW5nKCI7ICIuam9pbihlcnJvcnMpKQogICAgICAgIHN0LnN0b3AoKQoKICAgIG9wdGlvbmFsX2NvbHMgPSBkZXRlY3Rfb3B0aW9uYWxfY29sdW1ucyhkZikKCiAgICAjIOamguimgeS/oeaBrwogICAgd2l0aCBzdC5leHBhbmRlcigi5qaC6KaB5L+h5oGvIiwgZXhwYW5kZWQ9RmFsc2UpOgogICAgICAgIHN1bW1hcnkgPSBkZXNjcmliZV9kYXRhZnJhbWUoZGYsIG1hcHBlZF9kZikKICAgICAgICBzdC5qc29uKHN1bW1hcnksIGV4cGFuZGVkPUZhbHNlKQoKICAgICMg5Lik56eN5qih5byP77ya566A5rSB5qih5byP44CB5Lu/5Yi25qih5byPKDE6MSkKICAgIHRhYl9zaW1wbGUsIHRhYl9jbG9uZSA9IHN0LnRhYnMoWyLnroDmtIHmqKHlvI8iLCAi5Lu/5Yi25qih5byPKDE6MSkiXSkKCiAgICAjIC0tLS0tLS0tLS0g566A5rSB5qih5byP77yI5Y6f5pyJ77yJIC0tLS0tLS0tLS0KICAgIHdpdGggdGFiX3NpbXBsZToKICAgICAgICBzdC5zdWJoZWFkZXIoIuetm+mAiSIpCiAgICAgICAgY29sX2xlZnQsIGNvbF9yaWdodCA9IHN0LmNvbHVtbnMoMikKICAgICAgICBtYWpvcl9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgICAgIHRpdGxlX2NuID0gUkVRVUlSRURfRklFTERTX0NOWyJ0aXRsZSJdCgogICAgICAgIHdpdGggY29sX2xlZnQ6CiAgICAgICAgICAgIG1ham9ycyA9IHNvcnRlZChbdiBmb3IgdiBpbiBtYXBwZWRfZGZbbWFqb3JfY25dLmRyb3BuYSgpLnVuaXF1ZSgpIGlmIHN0cih2KS5zdHJpcCgpICE9ICIiXSkKICAgICAgICAgICAgc2VsZWN0ZWRfbWFqb3JzID0gc3QubXVsdGlzZWxlY3QoIuaMieS4k+S4muetm+mAie+8iOWPr+WkmumAie+8jOeVmeepuuS4uuWFqOmDqO+8iSIsIG1ham9ycykKICAgICAgICB3aXRoIGNvbF9yaWdodDoKICAgICAgICAgICAgdGl0bGVzID0gc29ydGVkKFt2IGZvciB2IGluIG1hcHBlZF9kZlt0aXRsZV9jbl0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKQogICAgICAgICAgICBzZWxlY3RlZF90aXRsZXMgPSBzdC5tdWx0aXNlbGVjdCgi5oyJ6IGM56ew562b6YCJ77yI5Y+v5aSa6YCJ77yM55WZ56m65Li65YWo6YOo77yJIiwgdGl0bGVzKQoKICAgICAgICBmaWx0ZXJlZF9kZiA9IG1hcHBlZF9kZi5jb3B5KCkKICAgICAgICBpZiBzZWxlY3RlZF9tYWpvcnM6CiAgICAgICAgICAgIGZpbHRlcmVkX2RmID0gZmlsdGVyZWRfZGZbZmlsdGVyZWRfZGZbbWFqb3JfY25dLmlzaW4oc2VsZWN0ZWRfbWFqb3JzKV0KICAgICAgICBpZiBzZWxlY3RlZF90aXRsZXM6CiAgICAgICAgICAgIGZpbHRlcmVkX2RmID0gZmlsdGVyZWRfZGZbZmlsdGVyZWRfZGZbdGl0bGVfY25dLmlzaW4oc2VsZWN0ZWRfdGl0bGVzKV0KCiAgICAgICAgc3QuY2FwdGlvbihmIuetm+mAieWQjuWFseaciSB7ZmlsdGVyZWRfZGYuc2hhcGVbMF19IOadoeiusOW9leOAgiIpCgogICAgICAgIHN0LnN1YmhlYWRlcigi6ZqP5py65oq95qC3IikKICAgICAgICBtb2RlID0gc3QucmFkaW8oIuaKveagt+aWueW8jyIsIG9wdGlvbnM9WyLmjInmlbDph48iLCAi5oyJ55m+5YiG5q+UIl0sIGhvcml6b250YWw9VHJ1ZSwga2V5PSJzaW1wbGVfbW9kZSIpCiAgICAgICAgY29sMSwgY29sMiwgY29sMyA9IHN0LmNvbHVtbnMoMykKICAgICAgICB3aXRoIGNvbDE6CiAgICAgICAgICAgIHNlZWQgPSBzdC50ZXh0X2lucHV0KCLpmo/mnLrnp43lrZDvvIjlj6/pgInvvIznlZnnqbrliJnmr4/mrKHkuI3lkIzvvIkiLCB2YWx1ZT0iIikKICAgICAgICB3aXRoIGNvbDI6CiAgICAgICAgICAgIGNvdW50ID0gc3QubnVtYmVyX2lucHV0KCLmir3lj5bmlbDph48iLCBtaW5fdmFsdWU9MCwgdmFsdWU9MTAsIHN0ZXA9MSkKICAgICAgICB3aXRoIGNvbDM6CiAgICAgICAgICAgIHBlcmNlbnQgPSBzdC5zbGlkZXIoIuaKveWPlueZvuWIhuavlCIsIG1pbl92YWx1ZT0xLCBtYXhfdmFsdWU9MTAwLCB2YWx1ZT0yMCwgc3RlcD0xKQoKICAgICAgICBzYW1wbGVfc2l6ZSA9IGNvbXB1dGVfc2FtcGxlX3NpemUoCiAgICAgICAgICAgIHRvdGFsPWZpbHRlcmVkX2RmLnNoYXBlWzBdLCBtb2RlPW1vZGUsIGNvdW50PWludChjb3VudCksIHBlcmNlbnQ9ZmxvYXQocGVyY2VudCkKICAgICAgICApCiAgICAgICAgc3QuY2FwdGlvbihmIuWwhuaKveWPliB7c2FtcGxlX3NpemV9IOadoeiusOW9leOAgiIpCgogICAgICAgIGlmIHN0LmJ1dHRvbigi5byA5aeL5oq95qC3IiwgdHlwZT0icHJpbWFyeSIsIGtleT0ic2ltcGxlX2RvX3NhbXBsZSIpOgogICAgICAgICAgICBzYW1wbGVkID0gc2FtcGxlX3Jvd3MoZmlsdGVyZWRfZGYsIHNhbXBsZV9zaXplLCBzZWVkIGlmIHNlZWQgIT0gIiIgZWxzZSBOb25lKQogICAgICAgICAgICBzdC5zdWNjZXNzKGYi5oq95qC35a6M5oiQ77yM5YWxIHtzYW1wbGVkLnNoYXBlWzBdfSDmnaHjgIIiKQogICAgICAgICAgICBzdC5kYXRhZnJhbWUoc2FtcGxlZCwgdXNlX2NvbnRhaW5lcl93aWR0aD1UcnVlKQoKICAgICAgICAgICAgIyDkuIvovb0KICAgICAgICAgICAgY3N2X2J5dGVzID0gc2FtcGxlZC50b19jc3YoaW5kZXg9RmFsc2UpLmVuY29kZSgidXRmLTgtc2lnIikKICAgICAgICAgICAgZXhjZWxfYnl0ZXMgPSB0b19leGNlbF9ieXRlcyhzYW1wbGVkKQogICAgICAgICAgICBkbF9jb2wxLCBkbF9jb2wyID0gc3QuY29sdW1ucygyKQogICAgICAgICAgICB3aXRoIGRsX2NvbDE6CiAgICAgICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oCiAgICAgICAgICAgICAgICAgICAgbGFiZWw9IuS4i+i9vSBDU1YiLAogICAgICAgICAgICAgICAgICAgIGRhdGE9Y3N2X2J5dGVzLAogICAgICAgICAgICAgICAgICAgIGZpbGVfbmFtZT0i5oq95qC35ZCN5Y2VLmNzdiIsCiAgICAgICAgICAgICAgICAgICAgbWltZT0idGV4dC9jc3YiLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB3aXRoIGRsX2NvbDI6CiAgICAgICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oCiAgICAgICAgICAgICAgICAgICAgbGFiZWw9IuS4i+i9vSBFeGNlbCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YT1leGNlbF9ieXRlcywKICAgICAgICAgICAgICAgICAgICBmaWxlX25hbWU9IuaKveagt+WQjeWNlS54bHN4IiwKICAgICAgICAgICAgICAgICAgICBtaW1lPSgKICAgICAgICAgICAgICAgICAgICAgICAgImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0IgogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICApCgogICAgIyAtLS0tLS0tLS0tIOS7v+WItuaooeW8jygxOjEpIC0tLS0tLS0tLS0KICAgIHdpdGggdGFiX2Nsb25lOgogICAgICAgIHN0LnN1YmhlYWRlcigi6aG555uuIikKICAgICAgICBjb2xfYSwgY29sX2IsIGNvbF9jID0gc3QuY29sdW1ucyhbMS4yLCAxLjIsIDFdKQogICAgICAgIHdpdGggY29sX2E6CiAgICAgICAgICAgIHByb2pfbmFtZSA9IHN0LnRleHRfaW5wdXQoIumhueebruWQjeensCIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggY29sX2I6CiAgICAgICAgICAgIGJpZF9ubyA9IHN0LnRleHRfaW5wdXQoIuaLm+agh+e8luWPtyIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggY29sX2M6CiAgICAgICAgICAgIGRyYXdfdGltZSA9IHN0LnRleHRfaW5wdXQoIuaKveWPluaXtumXtCIsIHZhbHVlPWRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlWS0lbS0lZCAlSDolTTolUyIpKQoKICAgICAgICBzdC5zdWJoZWFkZXIoIuaKveWPluadoeS7tiIpCiAgICAgICAgYzEsIGMyLCBjMywgYzQgPSBzdC5jb2x1bW5zKDQpCiAgICAgICAgbWFqb3JfY24gPSBSRVFVSVJFRF9GSUVMRFNfQ05bIm1ham9yIl0KICAgICAgICB0aXRsZV9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsidGl0bGUiXQoKICAgICAgICB3aXRoIGMxOgogICAgICAgICAgICBtYWpvcl9vcHRzID0gc29ydGVkKFt2IGZvciB2IGluIGRmW21ham9yX2NuXS5kcm9wbmEoKS51bmlxdWUoKSBpZiBzdHIodikuc3RyaXAoKSAhPSAiIl0pIGlmIG1ham9yX2NuIGluIGRmLmNvbHVtbnMgZWxzZSBbXQogICAgICAgICAgICBtYWpvcl9zZWwgPSBzdC5tdWx0aXNlbGVjdCgi5LiT5LiaIiwgbWFqb3Jfb3B0cywga2V5PSJjbG9uZV9tYWpvciIpCiAgICAgICAgd2l0aCBjMjoKICAgICAgICAgICAgdGl0bGVfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZlt0aXRsZV9jbl0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiB0aXRsZV9jbiBpbiBkZi5jb2x1bW5zIGVsc2UgW10KICAgICAgICAgICAgdGl0bGVfc2VsID0gc3QubXVsdGlzZWxlY3QoIuiBjOensCIsIHRpdGxlX29wdHMsIGtleT0iY2xvbmVfdGl0bGUiKQogICAgICAgIHdpdGggYzM6CiAgICAgICAgICAgIGdlbmRlcl9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgiZ2VuZGVyIikKICAgICAgICAgICAgZ2VuZGVyX29wdHMgPSBzb3J0ZWQoW3YgZm9yIHYgaW4gZGZbZ2VuZGVyX2NvbF0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiBnZW5kZXJfY29sIGVsc2UgW10KICAgICAgICAgICAgZ2VuZGVyX3NlbCA9IHN0LnNlbGVjdGJveCgi5oCn5YirIiwgWyLlhajpg6giXSArIGdlbmRlcl9vcHRzIGlmIGdlbmRlcl9vcHRzIGVsc2UgWyLlhajpg6giXSwgaW5kZXg9MCkKICAgICAgICB3aXRoIGM0OgogICAgICAgICAgICBiaXJ0aF9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgiYmlydGgiKQogICAgICAgICAgICBpZiBiaXJ0aF9jb2w6CiAgICAgICAgICAgICAgICBhZ2VzID0gY29tcHV0ZV9hZ2Vfc2VyaWVzKGRmW2JpcnRoX2NvbF0pCiAgICAgICAgICAgICAgICBtaW5fYWdlID0gaW50KGFnZXMubWluKCkpIGlmIGFnZXMubm90bmEoKS5hbnkoKSBlbHNlIDE4CiAgICAgICAgICAgICAgICBtYXhfYWdlID0gaW50KGFnZXMubWF4KCkpIGlmIGFnZXMubm90bmEoKS5hbnkoKSBlbHNlIDgwCiAgICAgICAgICAgICAgICBhZ2VfcmFuZ2UgPSBzdC5zbGlkZXIoIuW5tOm+hCIsIG1pbl92YWx1ZT1tYXgoMTYsIG1pbl9hZ2UpLCBtYXhfdmFsdWU9bWluKDEwMCwgbWF4X2FnZSksIHZhbHVlPShtYXgoMTgsIG1pbl9hZ2UpLCBtaW4oNjUsIG1heF9hZ2UpKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN0LndyaXRlKCLlubTpvoTvvJrml6Dlh7rnlJ/lubTmnIjvvIzml6Dms5XnrZvpgIkiKQogICAgICAgICAgICAgICAgYWdlX3JhbmdlID0gTm9uZQoKICAgICAgICBjNSwgYzYsIGM3LCBjOCA9IHN0LmNvbHVtbnMoNCkKICAgICAgICB3aXRoIGM1OgogICAgICAgICAgICBkZWdyZWVfY29sID0gb3B0aW9uYWxfY29scy5nZXQoImRlZ3JlZSIpCiAgICAgICAgICAgIGRlZ3JlZV9vcHRzID0gc29ydGVkKFt2IGZvciB2IGluIGRmW2RlZ3JlZV9jb2xdLmRyb3BuYSgpLnVuaXF1ZSgpIGlmIHN0cih2KS5zdHJpcCgpICE9ICIiXSkgaWYgZGVncmVlX2NvbCBlbHNlIFtdCiAgICAgICAgICAgIGRlZ3JlZV9zZWwgPSBzdC5zZWxlY3Rib3goIuWtpuWOhiIsIFsi5YWo6YOoIl0gKyBkZWdyZWVfb3B0cyBpZiBkZWdyZWVfb3B0cyBlbHNlIFsi5YWo6YOoIl0sIGluZGV4PTApCiAgICAgICAgd2l0aCBjNjoKICAgICAgICAgICAgcXVhbF9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgicXVhbGlmaWNhdGlvbiIpCiAgICAgICAgICAgIHF1YWxfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZltxdWFsX2NvbF0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiBxdWFsX2NvbCBlbHNlIFtdCiAgICAgICAgICAgIHF1YWxfc2VsID0gc3Quc2VsZWN0Ym94KCLms6jlhozotYTmoLwiLCBbIuWFqOmDqCJdICsgcXVhbF9vcHRzIGlmIHF1YWxfb3B0cyBlbHNlIFsi5YWo6YOoIl0sIGluZGV4PTApCiAgICAgICAgd2l0aCBjNzoKICAgICAgICAgICAgb3JnX2NvbCA9IG9wdGlvbmFsX2NvbHMuZ2V0KCJvcmciKQogICAgICAgICAgICBvcmdfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZltvcmdfY29sXS5kcm9wbmEoKS51bmlxdWUoKSBpZiBzdHIodikuc3RyaXAoKSAhPSAiIl0pIGlmIG9yZ19jb2wgZWxzZSBbXQogICAgICAgICAgICBvcmdfc2VsID0gc3QudGV4dF9pbnB1dCgi5bel5L2c5Y2V5L2NIOWMheWQq+WFs+mUruivjSIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggYzg6CiAgICAgICAgICAgIG51bV9wZW9wbGUgPSBzdC5udW1iZXJfaW5wdXQoIuS6uuaVsCIsIG1pbl92YWx1ZT0wLCB2YWx1ZT0xMCwgc3RlcD0xKQoKICAgICAgICAjIOWfuuS6juadoeS7tui/h+a7pAogICAgICAgIGNsb25lX2ZpbHRlcmVkID0gZGYuY29weSgpCiAgICAgICAgaWYgbWFqb3JfY24gaW4gY2xvbmVfZmlsdGVyZWQuY29sdW1ucyBhbmQgbWFqb3Jfc2VsOgogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW21ham9yX2NuXS5pc2luKG1ham9yX3NlbCldCiAgICAgICAgaWYgdGl0bGVfY24gaW4gY2xvbmVfZmlsdGVyZWQuY29sdW1ucyBhbmQgdGl0bGVfc2VsOgogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW3RpdGxlX2NuXS5pc2luKHRpdGxlX3NlbCldCiAgICAgICAgaWYgZ2VuZGVyX2NvbCBhbmQgZ2VuZGVyX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtnZW5kZXJfY29sXSA9PSBnZW5kZXJfc2VsXQogICAgICAgIGlmIGJpcnRoX2NvbCBhbmQgYWdlX3JhbmdlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhZ2VzID0gY29tcHV0ZV9hZ2Vfc2VyaWVzKGNsb25lX2ZpbHRlcmVkW2JpcnRoX2NvbF0pCiAgICAgICAgICAgIGNsb25lX2ZpbHRlcmVkID0gY2xvbmVfZmlsdGVyZWRbKGFnZXMgPj0gYWdlX3JhbmdlWzBdKSAmIChhZ2VzIDw9IGFnZV9yYW5nZVsxXSldCiAgICAgICAgaWYgZGVncmVlX2NvbCBhbmQgZGVncmVlX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtkZWdyZWVfY29sXSA9PSBkZWdyZWVfc2VsXQogICAgICAgIGlmIHF1YWxfY29sIGFuZCBxdWFsX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtxdWFsX2NvbF0gPT0gcXVhbF9zZWxdCiAgICAgICAgaWYgb3JnX2NvbCBhbmQgb3JnX3NlbC5zdHJpcCgpICE9ICIiOgogICAgICAgICAgICBrdyA9IG9yZ19zZWwuc3RyaXAoKQogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW29yZ19jb2xdLmFzdHlwZShzdHIpLnN0ci5jb250YWlucyhrdywgbmE9RmFsc2UpXQoKICAgICAgICBzdC5jYXB0aW9uKGYi56ym5ZCI5p2h5Lu26K6w5b2V77yae2Nsb25lX2ZpbHRlcmVkLnNoYXBlWzBdfSDkuroiKQoKICAgICAgICAjIOaKveWPli/miZPljbDmjInpkq4KICAgICAgICBidG5fY29sMSwgYnRuX2NvbDIgPSBzdC5jb2x1bW5zKFsxLCAxXSkKICAgICAgICBkb19kcmF3ID0gYnRuX2NvbDEuYnV0dG9uKCLmir3lj5YiLCB0eXBlPSJwcmltYXJ5Iiwga2V5PSJjbG9uZV9kcmF3IikKICAgICAgICBkb19wcmludCA9IGJ0bl9jb2wyLmJ1dHRvbigi5omT5Y2wIiwga2V5PSJjbG9uZV9wcmludCIpCgogICAgICAgIHNlbGVjdGVkID0gcGQuRGF0YUZyYW1lKCkKICAgICAgICBpZiBkb19kcmF3OgogICAgICAgICAgICBzZWxlY3RlZCA9IHNhbXBsZV9yb3dzKGNsb25lX2ZpbHRlcmVkLCBpbnQobnVtX3Blb3BsZSksIHNlZWQ9Tm9uZSkKICAgICAgICAgICAgc3Quc3VjY2VzcyhmIuW3suaKveWPliB7c2VsZWN0ZWQuc2hhcGVbMF19IOS6uuOAgiIpCiAgICAgICAgICAgICMg5bGV56S65LiO5LiL6L2977yI5L2/55So5Z+65pys5LqU5a2X5q6177yM5aaC5pyJ5Y+v6YCJ5a2X5q615YiZ6L+95Yqg5bGV56S677yJCiAgICAgICAgICAgIGJhc2VfY29scyA9IFsKICAgICAgICAgICAgICAgIFJFUVVJUkVEX0ZJRUxEU19DTlsibmFtZSJdLAogICAgICAgICAgICAgICAgbWFqb3JfY24gaWYgbWFqb3JfY24gaW4gc2VsZWN0ZWQuY29sdW1ucyBlbHNlIE5vbmUsCiAgICAgICAgICAgICAgICBSRVFVSVJFRF9GSUVMRFNfQ05bInBob25lIl0sCiAgICAgICAgICAgICAgICB0aXRsZV9jbiBpZiB0aXRsZV9jbiBpbiBzZWxlY3RlZC5jb2x1bW5zIGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgIFJFUVVJUkVEX0ZJRUxEU19DTlsiZW1haWwiXSwKICAgICAgICAgICAgXQogICAgICAgICAgICBiYXNlX2NvbHMgPSBbYyBmb3IgYyBpbiBiYXNlX2NvbHMgaWYgYyBhbmQgYyBpbiBzZWxlY3RlZC5jb2x1bW5zXQogICAgICAgICAgICBzaG93X2NvbHMgPSBiYXNlX2NvbHMuY29weSgpCiAgICAgICAgICAgIGZvciBvcHRfa2V5IGluIFsiZ2VuZGVyIiwgImJpcnRoIiwgIm9yZyIsICJwb3NpdGlvbiIsICJxdWFsaWZpY2F0aW9uIl06CiAgICAgICAgICAgICAgICBjb2wgPSBvcHRpb25hbF9jb2xzLmdldChvcHRfa2V5KQogICAgICAgICAgICAgICAgaWYgY29sIGFuZCBjb2wgaW4gc2VsZWN0ZWQuY29sdW1uczoKICAgICAgICAgICAgICAgICAgICBzaG93X2NvbHMuYXBwZW5kKGNvbCkKICAgICAgICAgICAgc3QuZGF0YWZyYW1lKHNlbGVjdGVkW3Nob3dfY29sc10gaWYgc2hvd19jb2xzIGVsc2Ugc2VsZWN0ZWQsIHVzZV9jb250YWluZXJfd2lkdGg9VHJ1ZSkKCiAgICAgICAgICAgICMg5LiL6L29CiAgICAgICAgICAgIGNzdl9ieXRlcyA9IChzZWxlY3RlZFtzaG93X2NvbHNdIGlmIHNob3dfY29scyBlbHNlIHNlbGVjdGVkKS50b19jc3YoaW5kZXg9RmFsc2UpLmVuY29kZSgidXRmLTgtc2lnIikKICAgICAgICAgICAgZXhjZWxfYnl0ZXMgPSB0b19leGNlbF9ieXRlcyhzZWxlY3RlZFtzaG93X2NvbHNdIGlmIHNob3dfY29scyBlbHNlIHNlbGVjdGVkKQogICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oIuS4i+i9vSBDU1YiLCBkYXRhPWNzdl9ieXRlcywgZmlsZV9uYW1lPSLmir3lj5bnu5PmnpwuY3N2IiwgbWltZT0idGV4dC9jc3YiKQogICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oIuS4i+i9vSBFeGNlbCIsIGRhdGE9ZXhjZWxfYnl0ZXMsIGZpbGVfbmFtZT0i5oq95Y+W57uT5p6cLnhsc3giLCBtaW1lPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCIpCgogICAgICAgICMg5omT5Y2w77yI55Sf5oiQ566A5rSBSFRNTOW5tuinpuWPkea1j+iniOWZqOaJk+WNsO+8iQogICAgICAgIGlmIGRvX3ByaW50OgogICAgICAgICAgICBwcmV2aWV3ID0gY2xvbmVfZmlsdGVyZWQuaGVhZCgyMDApICAjIOaJk+WNsOWJjemihOiniOS4gOmDqOWIhgogICAgICAgICAgICBodG1sX3RhYmxlID0gcHJldmlldy50b19odG1sKGluZGV4PUZhbHNlKQogICAgICAgICAgICBzdF9odG1sKAogICAgICAgICAgICAgICAgZiIiIgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPHN0eWxlPgogICAgICAgICAgICAgICAgICAgIHRhYmxlIHt7Ym9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsgd2lkdGg6IDEwMCU7IGZvbnQtc2l6ZTogMTJweDt9fQogICAgICAgICAgICAgICAgICAgIHRoLCB0ZCB7e2JvcmRlcjogMXB4IHNvbGlkICM5OTk7IHBhZGRpbmc6IDZweDt9fQogICAgICAgICAgICAgICAgICA8L3N0eWxlPgogICAgICAgICAgICAgICAgICB7aHRtbF90YWJsZX0KICAgICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJpbnQoKTsKICAgICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICIiIiwKICAgICAgICAgICAgICAgIGhlaWdodD01MDAsCiAgICAgICAgICAgICkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgbWFpbigpCg=="


def write_app_to_temp() -> str:
    if APP_CODE_B64 and APP_CODE_B64 != "aW1wb3J0IGlvCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBPcHRpb25hbCwgVHVwbGUKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBzdHJlYW1saXQgYXMgc3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBzdHJlYW1saXQuY29tcG9uZW50cy52MSBpbXBvcnQgaHRtbCBhcyBzdF9odG1sCgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0g6aG16Z2i5LiO5bi46YePIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpzdC5zZXRfcGFnZV9jb25maWcocGFnZV90aXRsZT0i5LiT5a625oq95qC35Yqp5omLIiwgcGFnZV9pY29uPSLwn46vIiwgbGF5b3V0PSJ3aWRlIikKClJFUVVJUkVEX0ZJRUxEU19DTiA9IHsKICAgICJuYW1lIjogIuWnk+WQjSIsCiAgICAibWFqb3IiOiAi5LiT5LiaIiwKICAgICJwaG9uZSI6ICLmiYvmnLrlj7ciLAogICAgInRpdGxlIjogIuiBjOensCIsCiAgICAiZW1haWwiOiAi6YKu566xIiwKfQoKUE9TU0lCTEVfQ09MVU1OX0FMSUFTRVM6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0gewogICAgIm5hbWUiOiBbIuWnk+WQjSIsICLlkI3lrZciLCAiTmFtZSIsICLlp5PlkI0vTmFtZSIsICLlkZjlt6Xlp5PlkI0iXSwKICAgICJtYWpvciI6IFsi5LiT5LiaIiwgIuS4k+S4muaWueWQkSIsICJNYWpvciIsICLlrabnp5EiLCAi6aKG5Z+fIl0sCiAgICAicGhvbmUiOiBbIuaJi+acuuWPtyIsICLmiYvmnLoiLCAi55S16K+dIiwgIuiBlOezu+eUteivnSIsICJQaG9uZSIsICJNb2JpbGUiLCAi5omL5py65Y+356CBIiwgIuiBlOezu+aJi+acuiJdLAogICAgInRpdGxlIjogWyLogYznp7AiLCAi5oqA5pyv6IGM56ewIiwgIlRpdGxlIiwgIuWyl+S9jSIsICLlspfkvY0v6IGM56ewIl0sCiAgICAiZW1haWwiOiBbIumCrueusSIsICLnlLXlrZDpgq7nrrEiLCAiRW1haWwiLCAiRS1tYWlsIl0sCn0KCiMg5Y+v6YCJ5a2X5q6177yM55So5LqO5Lu/5Yi255WM6Z2i5pu05aSa562b6YCJL+WxleekugpPUFRJT05BTF9BTElBU0VTOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHsKICAgICJnZW5kZXIiOiBbIuaAp+WIqyIsICJHZW5kZXIiXSwKICAgICJiaXJ0aCI6IFsi5Ye655Sf5bm05pyIIiwgIuWHuueUn+aXpeacnyIsICLlh7rnlJ8iLCAi55Sf5pelIl0sCiAgICAiaWRjYXJkIjogWyLouqvku73or4Hlj7ciLCAi6Lqr5Lu96K+B5Y+356CBIiwgIuivgeS7tuWPt+eggSJdLAogICAgIm9yZyI6IFsi5L6b6IGM5Y2V5L2NIiwgIuWNleS9jSIsICLlt6XkvZzljZXkvY0iLCAi5omA5Zyo5Y2V5L2NIl0sCiAgICAicG9zaXRpb24iOiBbIuiBjOWKoSIsICLlspfkvY0iLCAi6IGM5L2NIl0sCiAgICAiZGVncmVlIjogWyLlrabljoYiLCAi5pyA6auY5a2m5Y6GIl0sCiAgICAicXVhbGlmaWNhdGlvbiI6IFsi5rOo5YaM6LWE5qC8IiwgIui1hOagvCIsICLms6jlhozor4HkuaYiXSwKICAgICJjb250YWN0IjogWyLogZTns7vmlrnlvI8iLCAi6IGU57O755S16K+dIiwgIuiBlOezu+aJi+acuiIsICLmiYvmnLrlj7fnoIEiLCAi5omL5py65Y+3IiwgIueUteivnSJdLAogICAgImNvbnRhY3RfcmVzdWx0IjogWyLogZTns7vnu5PmnpwiLCAi5Zue6K6/57uT5p6cIl0sCn0KClNVUFBPUlRFRF9FWFRFTlNJT05TID0gWyIueGxzeCIsICIueGxzIiwgIi5jc3YiXQoKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIOW3peWFt+WHveaVsCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KQHN0LmNhY2hlX2RhdGEoc2hvd19zcGlubmVyPUZhbHNlKQpkZWYgbG9hZF9kYXRhZnJhbWUoZmlsZV9ieXRlczogYnl0ZXMsIGZpbGVuYW1lOiBzdHIpIC0+IHBkLkRhdGFGcmFtZToKICAgIGZpbGVuYW1lX2xvd2VyID0gZmlsZW5hbWUubG93ZXIoKQogICAgaWYgZmlsZW5hbWVfbG93ZXIuZW5kc3dpdGgoIi5jc3YiKToKICAgICAgICAjIOiHquWKqOWwneivleW4uOingee8lueggQogICAgICAgIGZvciBlbmMgaW4gWyJ1dGYtOCIsICJnYmsiLCAiZ2IyMzEyIiwgInV0Zi04LXNpZyJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4gcGQucmVhZF9jc3YoaW8uQnl0ZXNJTyhmaWxlX2J5dGVzKSwgZW5jb2Rpbmc9ZW5jKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICByZXR1cm4gcGQucmVhZF9jc3YoaW8uQnl0ZXNJTyhmaWxlX2J5dGVzKSkKICAgIGVsaWYgZmlsZW5hbWVfbG93ZXIuZW5kc3dpdGgoIi54bHMiKToKICAgICAgICByZXR1cm4gcGQucmVhZF9leGNlbChpby5CeXRlc0lPKGZpbGVfYnl0ZXMpLCBlbmdpbmU9InhscmQiKQogICAgZWxzZToKICAgICAgICByZXR1cm4gcGQucmVhZF9leGNlbChpby5CeXRlc0lPKGZpbGVfYnl0ZXMpLCBlbmdpbmU9Im9wZW5weXhsIikKCgpkZWYgbm9ybWFsaXplX2NvbHVtbnMoZGY6IHBkLkRhdGFGcmFtZSkgLT4gcGQuRGF0YUZyYW1lOgogICAgbmV3X2RmID0gZGYuY29weSgpCiAgICBuZXdfZGYuY29sdW1ucyA9IFtzdHIoYykuc3RyaXAoKSBmb3IgYyBpbiBuZXdfZGYuY29sdW1uc10KICAgIHJldHVybiBuZXdfZGYKCgpkZWYgX2lzX2VtcHR5X3ZhbHVlKHY6IG9iamVjdCkgLT4gYm9vbDoKICAgIHMgPSBzdHIodikuc3RyaXAoKQogICAgcmV0dXJuIHMgPT0gIiIgb3Igcy5sb3dlcigpIGluIHsibmFuIiwgIm5vbmUiLCAibnVsbCJ9CgoKZGVmIGF1dG9fbG9jYXRlX2hlYWRlcl9ieV9rZXl3b3JkKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuagueaNruWMheWQq+KAnOW6j+WPt+KAneetieWFs+mUruivjeeahOihjOiHquWKqOWumuS9jeihqOWktOOAggogICAg562W55Wl77ya6KGM5Lit5YyF5ZCr4oCc5bqP5Y+34oCd77yM5LiU5LiO5bi46KeB6KGo5aS05YWz6ZSu6K+N5Lqk6ZuGPj0z77yM5YiZ6K+l6KGM5Li66KGo5aS077ybCiAgICDku6Xor6XooYzkuYvkuIvkuIDooYzkuLrmlbDmja7lvIDlp4vvvJvlsIbor6XooYzotYvkuLrliJflkI3jgIIKICAgICIiIgogICAgaWYgZGYuZW1wdHk6CiAgICAgICAgcmV0dXJuIGRmCiAgICBzID0gZGYuYXN0eXBlKHN0cikuYXBwbHltYXAobGFtYmRhIHg6IHN0cih4KS5zdHJpcCgpKQogICAgaGVhZGVyX2tleXdvcmRzID0geyLluo/lj7ciLCAi5aeT5ZCNIiwgIuaAp+WIqyIsICLlh7rnlJ/lubTmnIgiLCAi6Lqr5Lu96K+B5Y+3IiwgIuS4k+S4miIsICLmiYvmnLrlj7fnoIEiLCAi5omL5py65Y+3IiwgIuS+m+iBjOWNleS9jSIsICLljZXkvY0iLCAi6IGM56ewIiwgIuiBjOWKoSIsICLnlLXlrZDpgq7nrrEiLCAi6YKu566xIiwgIuWkh+azqCJ9CiAgICBoZWFkZXJfcm93X2lkeDogT3B0aW9uYWxbaW50XSA9IE5vbmUKICAgIGZvciBpLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHZhbHMgPSBbdiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KV0KICAgICAgICBpZiBub3QgdmFsczoKICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiAi5bqP5Y+3IiBpbiB2YWxzOgogICAgICAgICAgICBpZiBsZW4oc2V0KHZhbHMpICYgaGVhZGVyX2tleXdvcmRzKSA+PSAzOgogICAgICAgICAgICAgICAgaGVhZGVyX3Jvd19pZHggPSBpCiAgICAgICAgICAgICAgICBicmVhawogICAgaWYgaGVhZGVyX3Jvd19pZHggaXMgTm9uZToKICAgICAgICByZXR1cm4gZGYKICAgIGNvbHVtbnMgPSBzLmlsb2NbaGVhZGVyX3Jvd19pZHhdLnRvbGlzdCgpCiAgICBjb2x1bW5zID0gW2MgaWYgbm90IF9pc19lbXB0eV92YWx1ZShjKSBlbHNlIGYi5YiXe2orMX0iIGZvciBqLCBjIGluIGVudW1lcmF0ZShjb2x1bW5zKV0KICAgIGJvZHkgPSBkZi5pbG9jW2hlYWRlcl9yb3dfaWR4ICsgMSA6XS5jb3B5KCkKICAgIGJvZHkuY29sdW1ucyA9IGNvbHVtbnMKICAgIHJldHVybiBub3JtYWxpemVfY29sdW1ucyhib2R5KQoKCmRlZiBkcm9wX2dyb3VwX2hlYWRlcl9yb3dzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuWIoOmZpOS7heWMheWQq+S4gOS4qumdnuepuuaWh+acrO+8jOS4lOivpeaWh+acrOeWkeS8vOWIhue7hOagh+mimOeahOihjO+8jOS+i+WmguKAnOS/oeaBr+WMluS4k+S4muKAneOAggogICAg5Yik5a6a6KeE5YiZ77yaCiAgICAtIOihjOWGhemdnuepuuWNleWFg+agvOaVsOmHjzw9Mu+8jOS4lAogICAgLSDlrZjlnKjpnZ7nqbrlgLzmu6HotrPvvJrnrYnkuo7igJzkv6Hmga/ljJbkuJPkuJrigJ3miJbku6XigJzkuJPkuJrigJ3nu5PlsL7miJbku6XigJznsbvliKvigJ3nu5PlsL4KICAgICIiIgogICAgaWYgZGYuZW1wdHk6CiAgICAgICAgcmV0dXJuIGRmCiAgICBzID0gZGYuYXN0eXBlKHN0cikuYXBwbHltYXAobGFtYmRhIHg6IHN0cih4KS5zdHJpcCgpKQogICAgbWFza19kcm9wID0gW10KICAgIGZvciBfLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHZhbHMgPSBbdiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KV0KICAgICAgICBpZiBsZW4odmFscykgPD0gMjoKICAgICAgICAgICAgY2FuZGlkYXRlID0gIiIuam9pbih2YWxzKQogICAgICAgICAgICBjYW5kaWRhdGUgPSBjYW5kaWRhdGUucmVwbGFjZSgiICIsICIiKQogICAgICAgICAgICBpZiBjYW5kaWRhdGUgaW4geyLkv6Hmga/ljJbkuJPkuJoifSBvciBjYW5kaWRhdGUuZW5kc3dpdGgoIuS4k+S4miIpIG9yIGNhbmRpZGF0ZS5lbmRzd2l0aCgi57G75YirIik6CiAgICAgICAgICAgICAgICBtYXNrX2Ryb3AuYXBwZW5kKFRydWUpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIG1hc2tfZHJvcC5hcHBlbmQoRmFsc2UpCiAgICByZXR1cm4gZGYubG9jW1tub3QgeCBmb3IgeCBpbiBtYXNrX2Ryb3BdXQoKCmRlZiBkcm9wX2VtYmVkZGVkX2hlYWRlcl9yb3dzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIuWIoOmZpOihqOWGhemHjeWkjeeahOihqOWktOihjO+8iOS+i+WmguWIhumhteWQjuWPiOWHuueOsOS4gOasoeKAmOWnk+WQjS/kuJPkuJov6IGM56ewLy4uLuKAme+8ieOAggogICAg6KeE5YiZ77ya5aaC5p6c5pys6KGM5ZCr5pyJ6Iez5bCRM+S4quWtl+auteWQjeWFs+mUruWtl++8jOWImeWIpOWumuS4uuihqOWktOihjOOAggogICAgIiIiCiAgICBpZiBkZi5lbXB0eToKICAgICAgICByZXR1cm4gZGYKICAgIGhlYWRlcl9rZXl3b3JkcyA9IHNldChSRVFVSVJFRF9GSUVMRFNfQ04udmFsdWVzKCkpIHwgeyLmgKfliKsiLCAi5Ye655Sf5bm05pyIIiwgIui6q+S7veivgeWPtyIsICLljZXkvY0iLCAi5L6b6IGM5Y2V5L2NIiwgIuiBjOWKoSIsICLnlLXlrZDpgq7nrrEiLCAi5aSH5rOoIn0KICAgIHMgPSBkZi5hc3R5cGUoc3RyKS5hcHBseW1hcChsYW1iZGEgeDogc3RyKHgpLnN0cmlwKCkpCiAgICBrZWVwX2ZsYWdzOiBMaXN0W2Jvb2xdID0gW10KICAgIGZvciBfLCByb3cgaW4gcy5pdGVycm93cygpOgogICAgICAgIHJvd19zZXQgPSBzZXQodiBmb3IgdiBpbiByb3cudG9saXN0KCkgaWYgbm90IF9pc19lbXB0eV92YWx1ZSh2KSkKICAgICAgICBpbnRlcnNlY3RfY250ID0gbGVuKHJvd19zZXQgJiBoZWFkZXJfa2V5d29yZHMpCiAgICAgICAga2VlcF9mbGFncy5hcHBlbmQoaW50ZXJzZWN0X2NudCA8IDMpCiAgICByZXR1cm4gZGYubG9jW2tlZXBfZmxhZ3NdCgoKZGVmIF9maW5kX2ZpcnN0X21hdGNoKGRmOiBwZC5EYXRhRnJhbWUsIGFsaWFzZXM6IExpc3Rbc3RyXSkgLT4gT3B0aW9uYWxbc3RyXToKICAgIGNvbHMgPSBsaXN0KGRmLmNvbHVtbnMpCiAgICBjb2xzX2xjID0ge2M6IHN0cihjKS5sb3dlcigpIGZvciBjIGluIGNvbHN9CiAgICBmb3IgYSBpbiBhbGlhc2VzOgogICAgICAgICMg57K+56GuCiAgICAgICAgZm9yIGMgaW4gY29sczoKICAgICAgICAgICAgaWYgc3RyKGMpLnN0cmlwKCkgPT0gYToKICAgICAgICAgICAgICAgIHJldHVybiBjCiAgICAgICAgIyDmqKHns4rljIXlkKsKICAgICAgICBhX2xjID0gYS5sb3dlcigpCiAgICAgICAgZm9yIGMsIGNfbGMgaW4gY29sc19sYy5pdGVtcygpOgogICAgICAgICAgICBpZiBhX2xjIGluIGNfbGM6CiAgICAgICAgICAgICAgICByZXR1cm4gYwogICAgcmV0dXJuIE5vbmUKCgpkZWYgZ3Vlc3NfbWFwcGluZyhkZjogcGQuRGF0YUZyYW1lKSAtPiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV06CiAgICBtYXBwaW5nOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0gPSB7azogTm9uZSBmb3IgayBpbiBSRVFVSVJFRF9GSUVMRFNfQ04ua2V5cygpfQoKICAgIGZvciBmaWVsZCwgYWxpYXNlcyBpbiBQT1NTSUJMRV9DT0xVTU5fQUxJQVNFUy5pdGVtcygpOgogICAgICAgIGNvbCA9IF9maW5kX2ZpcnN0X21hdGNoKGRmLCBhbGlhc2VzKQogICAgICAgIGlmIGNvbCBpcyBub3QgTm9uZToKICAgICAgICAgICAgbWFwcGluZ1tmaWVsZF0gPSBjb2wKICAgIHJldHVybiBtYXBwaW5nCgoKZGVmIGJ1aWxkX21hcHBlZF9kZihkZjogcGQuRGF0YUZyYW1lLCBtYXBwaW5nOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0pIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgTGlzdFtzdHJdXToKICAgIGVycm9yczogTGlzdFtzdHJdID0gW10KICAgIHNlbGVjdGVkX2NvbHMgPSB7fQogICAgZm9yIGtleSwgY24gaW4gUkVRVUlSRURfRklFTERTX0NOLml0ZW1zKCk6CiAgICAgICAgY29sID0gbWFwcGluZy5nZXQoa2V5KQogICAgICAgIGlmIGNvbCBpcyBOb25lOgogICAgICAgICAgICBlcnJvcnMuYXBwZW5kKGYi5pyq6YCJ5oup5a2X5q6177yae2NufSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZWN0ZWRfY29sc1tjbl0gPSBkZltjb2xdCiAgICBpZiBlcnJvcnM6CiAgICAgICAgcmV0dXJuIHBkLkRhdGFGcmFtZSgpLCBlcnJvcnMKCiAgICByZXN1bHQgPSBwZC5EYXRhRnJhbWUoc2VsZWN0ZWRfY29scykKCiAgICAjIOi9u+W6pua4hea0lwogICAgZm9yIGMgaW4gcmVzdWx0LmNvbHVtbnM6CiAgICAgICAgcmVzdWx0W2NdID0gcmVzdWx0W2NdLmFzdHlwZShzdHIpLnN0ci5zdHJpcCgpLnJlcGxhY2UoeyJuYW4iOiAiIiwgIk5vbmUiOiAiIiwgIm51bGwiOiAiIiwgIk5hTiI6ICIifSkKCiAgICAjIOaJi+acuuWPt+S7heS/neeVmeaVsOWtlwogICAgcmVzdWx0W1JFUVVJUkVEX0ZJRUxEU19DTlsicGhvbmUiXV0gPSAoCiAgICAgICAgcmVzdWx0W1JFUVVJUkVEX0ZJRUxEU19DTlsicGhvbmUiXV0KICAgICAgICAuc3RyLnJlcGxhY2UociJbXjAtOV0iLCAiIiwgcmVnZXg9VHJ1ZSkKICAgICAgICAuc3RyLnNsaWNlKDAsIDIwKQogICAgKQoKICAgICMg5Yig6Zmk55aR5Ly85qCH6aKYL+WIhumalOihjO+8iOaYoOWwhOWQjuWGjeWFnOW6leS4gOasoe+8iQogICAgbmFtZV9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibmFtZSJdCiAgICBtYWpvcl9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgdGl0bGVfY24gPSBSRVFVSVJFRF9GSUVMRFNfQ05bInRpdGxlIl0KICAgIG1hc2sgPSB+KAogICAgICAgIChyZXN1bHRbbmFtZV9jbl0uZXEoIiIpICYgKHJlc3VsdFtbbWFqb3JfY24sIHRpdGxlX2NuXV0ucmVwbGFjZSgiIiwgcGQuTkEpLm5vdG5hKCkuc3VtKGF4aXM9MSkgPD0gMSkpCiAgICAgICAgfCAocmVzdWx0W25hbWVfY25dLmlzaW4oWyLlp5PlkI0iLCAi5L+h5oGv5YyW5LiT5LiaIl0pKQogICAgICAgIHwgKHJlc3VsdFttYWpvcl9jbl0uaXNpbihbIuS/oeaBr+WMluS4k+S4miJdKSkKICAgICkKICAgIHJlc3VsdCA9IHJlc3VsdC5sb2NbbWFza10KCiAgICByZXR1cm4gcmVzdWx0LCBbXQoKCmRlZiBkZXNjcmliZV9kYXRhZnJhbWUoZGY6IHBkLkRhdGFGcmFtZSwgbWFwcGVkX2RmOiBPcHRpb25hbFtwZC5EYXRhRnJhbWVdID0gTm9uZSkgLT4gRGljdFtzdHIsIG9iamVjdF06CiAgICBzdW1tYXJ5ID0gewogICAgICAgICLooYzmlbAiOiBpbnQoZGYuc2hhcGVbMF0pLAogICAgICAgICLliJfmlbAiOiBpbnQoZGYuc2hhcGVbMV0pLAogICAgICAgICLliJflkI0iOiBsaXN0KG1hcChzdHIsIGRmLmNvbHVtbnMpKSwKICAgIH0KICAgIGlmIG1hcHBlZF9kZiBpcyBub3QgTm9uZSBhbmQgbm90IG1hcHBlZF9kZi5lbXB0eToKICAgICAgICBtYWpvciA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgICAgIHRpdGxlID0gUkVRVUlSRURfRklFTERTX0NOWyJ0aXRsZSJdCiAgICAgICAgc3VtbWFyeS51cGRhdGUoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGYi5ZSv5LiAe21ham9yfeaVsCI6IGludChtYXBwZWRfZGZbbWFqb3JdLnJlcGxhY2UoIiIsIHBkLk5BKS5udW5pcXVlKGRyb3BuYT1UcnVlKSksCiAgICAgICAgICAgICAgICBmIuWUr+S4gHt0aXRsZX3mlbAiOiBpbnQobWFwcGVkX2RmW3RpdGxlXS5yZXBsYWNlKCIiLCBwZC5OQSkubnVuaXF1ZShkcm9wbmE9VHJ1ZSkpLAogICAgICAgICAgICAgICAgIue8uuWksee7n+iuoSI6IG1hcHBlZF9kZi5yZXBsYWNlKCIiLCBwZC5OQSkuaXNuYSgpLnN1bSgpLnRvX2RpY3QoKSwKICAgICAgICAgICAgfQogICAgICAgICkKICAgIHJldHVybiBzdW1tYXJ5CgoKZGVmIGNvbXB1dGVfc2FtcGxlX3NpemUodG90YWw6IGludCwgbW9kZTogc3RyLCBjb3VudDogaW50LCBwZXJjZW50OiBmbG9hdCkgLT4gaW50OgogICAgaWYgdG90YWwgPD0gMDoKICAgICAgICByZXR1cm4gMAogICAgaWYgbW9kZSA9PSAi5oyJ5pWw6YePIjoKICAgICAgICByZXR1cm4gaW50KG1heCgwLCBtaW4odG90YWwsIGNvdW50KSkpCiAgICAjIOaMieeZvuWIhuavlAogICAgbiA9IGludChucC5mbG9vcih0b3RhbCAqIChwZXJjZW50IC8gMTAwLjApKSkKICAgIHJldHVybiBtYXgoMSBpZiB0b3RhbCA+IDAgZWxzZSAwLCBtaW4odG90YWwsIG4pKQoKCmRlZiBzYW1wbGVfcm93cyhkZjogcGQuRGF0YUZyYW1lLCBzYW1wbGVfc2l6ZTogaW50LCBzZWVkOiBPcHRpb25hbFtpbnRdKSAtPiBwZC5EYXRhRnJhbWU6CiAgICBpZiBzYW1wbGVfc2l6ZSA8PSAwIG9yIGRmLmVtcHR5OgogICAgICAgIHJldHVybiBkZi5pbG9jWzA6MF0KICAgIHJuZyA9IG5wLnJhbmRvbS5kZWZhdWx0X3JuZyhOb25lIGlmIHNlZWQgaW4gKE5vbmUsICIiKSBlbHNlIGludChzZWVkKSkKICAgIGlkeCA9IHJuZy5jaG9pY2UoZGYuaW5kZXgudmFsdWVzLCBzaXplPXNhbXBsZV9zaXplLCByZXBsYWNlPUZhbHNlKQogICAgcmV0dXJuIGRmLmxvY1tpZHhdCgoKZGVmIHRvX2V4Y2VsX2J5dGVzKGRmOiBwZC5EYXRhRnJhbWUpIC0+IGJ5dGVzOgogICAgYnVmID0gaW8uQnl0ZXNJTygpCiAgICB3aXRoIHBkLkV4Y2VsV3JpdGVyKGJ1ZiwgZW5naW5lPSJvcGVucHl4bCIpIGFzIHdyaXRlcjoKICAgICAgICBkZi50b19leGNlbCh3cml0ZXIsIGluZGV4PUZhbHNlKQogICAgYnVmLnNlZWsoMCkKICAgIHJldHVybiBidWYucmVhZCgpCgoKZGVmIGRldGVjdF9vcHRpb25hbF9jb2x1bW5zKGRmOiBwZC5EYXRhRnJhbWUpIC0+IERpY3Rbc3RyLCBPcHRpb25hbFtzdHJdXToKICAgIGZvdW5kOiBEaWN0W3N0ciwgT3B0aW9uYWxbc3RyXV0gPSB7fQogICAgZm9yIGssIGFsaWFzZXMgaW4gT1BUSU9OQUxfQUxJQVNFUy5pdGVtcygpOgogICAgICAgIGZvdW5kW2tdID0gX2ZpbmRfZmlyc3RfbWF0Y2goZGYsIGFsaWFzZXMpCiAgICByZXR1cm4gZm91bmQKCgpkZWYgY29tcHV0ZV9hZ2Vfc2VyaWVzKGJpcnRoX3NlcmllczogcGQuU2VyaWVzKSAtPiBwZC5TZXJpZXM6CiAgICBkdCA9IHBkLnRvX2RhdGV0aW1lKGJpcnRoX3NlcmllcywgZXJyb3JzPSJjb2VyY2UiKQogICAgdG9kYXkgPSBwZC5UaW1lc3RhbXAudG9kYXkoKS5ub3JtYWxpemUoKQogICAgYWdlID0gKHRvZGF5IC0gZHQpLmR0LmRheXMgLy8gMzY1CiAgICByZXR1cm4gYWdlCgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0g5bqU55So5Li75L2TIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpkZWYgbWFpbigpIC0+IE5vbmU6CiAgICBzdC50aXRsZSgi8J+OryDkuJPlrrbmir3moLfliqnmiYsiKQogICAgc3QuY2FwdGlvbigi5LiK5Lyg5LiT5a625bqT77yIRXhjZWwvQ1NW77yJ77yM6Ieq5Yqo5a6a5L2N6KGo5aS0IOKGkiDmuIXmtJcg4oaSIOaYoOWwhCDihpIg562b6YCJL+aKveagtyDihpIg5a+85Ye6IikKCiAgICB1cGxvYWRlZCA9IHN0LmZpbGVfdXBsb2FkZXIoCiAgICAgICAgbGFiZWw9IuS4iuS8oOaWh+S7tiAo5pSv5oyBIC54bHN4Ly54bHMvLmNzdikiLAogICAgICAgIHR5cGU9WyJ4bHN4IiwgInhscyIsICJjc3YiXSwKICAgICAgICBhY2NlcHRfbXVsdGlwbGVfZmlsZXM9RmFsc2UsCiAgICApCgogICAgaWYgbm90IHVwbG9hZGVkOgogICAgICAgIHN0LmluZm8oIuivt+WFiOS4iuS8oOaWh+S7tuOAguaUr+aMgSBFeGNlbCDmiJYgQ1NW44CCIikKICAgICAgICBzdC5zdG9wKCkKCiAgICB0cnk6CiAgICAgICAgcmF3X2RmID0gbG9hZF9kYXRhZnJhbWUodXBsb2FkZWQuZ2V0dmFsdWUoKSwgdXBsb2FkZWQubmFtZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBzdC5lcnJvcihmIuivu+WPluaWh+S7tuWksei0pe+8mntlfSIpCiAgICAgICAgc3Quc3RvcCgpCgogICAgIyDoh6rliqjlrprkvY3ooajlpLTooYzvvIjln7rkuo7igJzluo/lj7figJ3nrYnlhbPplK7lrZfvvIkKICAgIGRmID0gYXV0b19sb2NhdGVfaGVhZGVyX2J5X2tleXdvcmQocmF3X2RmKQogICAgIyDop4TojIPliJflkI0gKyDmuIXmtJfmnYLpobnooYwKICAgIGRmID0gbm9ybWFsaXplX2NvbHVtbnMoZGYpCiAgICBkZiA9IGRyb3BfZ3JvdXBfaGVhZGVyX3Jvd3MoZGYpCiAgICBkZiA9IGRyb3BfZW1iZWRkZWRfaGVhZGVyX3Jvd3MoZGYpCgogICAgc3Quc3ViaGVhZGVyKCLmlbDmja7pooTop4jvvIjoh6rliqjlrprkvY3ooajlpLQgKyDmuIXmtJflkI7vvIkiKQogICAgc3QuZGF0YWZyYW1lKGRmLmhlYWQoNTApLCB1c2VfY29udGFpbmVyX3dpZHRoPVRydWUpCgogICAgIyDlrZfmrrXmmKDlsITvvIjlv4XloavvvIkKICAgIHN0LnN1YmhlYWRlcigi5a2X5q615pig5bCEIikKICAgIGRlZmF1bHRfbWFwcGluZyA9IGd1ZXNzX21hcHBpbmcoZGYpCgogICAgbWFwcGluZzogRGljdFtzdHIsIE9wdGlvbmFsW3N0cl1dID0ge30KICAgIGNvbHMgPSBzdC5jb2x1bW5zKDUpCiAgICBmb3IgaSwgKGtleSwgY24pIGluIGVudW1lcmF0ZShSRVFVSVJFRF9GSUVMRFNfQ04uaXRlbXMoKSk6CiAgICAgICAgd2l0aCBjb2xzW2kgJSA1XToKICAgICAgICAgICAgbWFwcGluZ1trZXldID0gc3Quc2VsZWN0Ym94KAogICAgICAgICAgICAgICAgbGFiZWw9ZiJ7Y259IOWtl+autSIsCiAgICAgICAgICAgICAgICBvcHRpb25zPVtOb25lXSArIGxpc3QoZGYuY29sdW1ucyksCiAgICAgICAgICAgICAgICBpbmRleD0oCiAgICAgICAgICAgICAgICAgICAgW05vbmVdICsgbGlzdChkZi5jb2x1bW5zKQogICAgICAgICAgICAgICAgKS5pbmRleChkZWZhdWx0X21hcHBpbmcuZ2V0KGtleSkpIGlmIGRlZmF1bHRfbWFwcGluZy5nZXQoa2V5KSBpbiBkZi5jb2x1bW5zIGVsc2UgMCwKICAgICAgICAgICAgICAgIGZvcm1hdF9mdW5jPWxhbWJkYSB4OiAi5pyq6YCJ5oupIiBpZiB4IGlzIE5vbmUgZWxzZSBzdHIoeCksCiAgICAgICAgICAgICkKCiAgICBtYXBwZWRfZGYsIGVycm9ycyA9IGJ1aWxkX21hcHBlZF9kZihkZiwgbWFwcGluZykKICAgIGlmIGVycm9yczoKICAgICAgICBzdC53YXJuaW5nKCI7ICIuam9pbihlcnJvcnMpKQogICAgICAgIHN0LnN0b3AoKQoKICAgIG9wdGlvbmFsX2NvbHMgPSBkZXRlY3Rfb3B0aW9uYWxfY29sdW1ucyhkZikKCiAgICAjIOamguimgeS/oeaBrwogICAgd2l0aCBzdC5leHBhbmRlcigi5qaC6KaB5L+h5oGvIiwgZXhwYW5kZWQ9RmFsc2UpOgogICAgICAgIHN1bW1hcnkgPSBkZXNjcmliZV9kYXRhZnJhbWUoZGYsIG1hcHBlZF9kZikKICAgICAgICBzdC5qc29uKHN1bW1hcnksIGV4cGFuZGVkPUZhbHNlKQoKICAgICMg5Lik56eN5qih5byP77ya566A5rSB5qih5byP44CB5Lu/5Yi25qih5byPKDE6MSkKICAgIHRhYl9zaW1wbGUsIHRhYl9jbG9uZSA9IHN0LnRhYnMoWyLnroDmtIHmqKHlvI8iLCAi5Lu/5Yi25qih5byPKDE6MSkiXSkKCiAgICAjIC0tLS0tLS0tLS0g566A5rSB5qih5byP77yI5Y6f5pyJ77yJIC0tLS0tLS0tLS0KICAgIHdpdGggdGFiX3NpbXBsZToKICAgICAgICBzdC5zdWJoZWFkZXIoIuetm+mAiSIpCiAgICAgICAgY29sX2xlZnQsIGNvbF9yaWdodCA9IHN0LmNvbHVtbnMoMikKICAgICAgICBtYWpvcl9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsibWFqb3IiXQogICAgICAgIHRpdGxlX2NuID0gUkVRVUlSRURfRklFTERTX0NOWyJ0aXRsZSJdCgogICAgICAgIHdpdGggY29sX2xlZnQ6CiAgICAgICAgICAgIG1ham9ycyA9IHNvcnRlZChbdiBmb3IgdiBpbiBtYXBwZWRfZGZbbWFqb3JfY25dLmRyb3BuYSgpLnVuaXF1ZSgpIGlmIHN0cih2KS5zdHJpcCgpICE9ICIiXSkKICAgICAgICAgICAgc2VsZWN0ZWRfbWFqb3JzID0gc3QubXVsdGlzZWxlY3QoIuaMieS4k+S4muetm+mAie+8iOWPr+WkmumAie+8jOeVmeepuuS4uuWFqOmDqO+8iSIsIG1ham9ycykKICAgICAgICB3aXRoIGNvbF9yaWdodDoKICAgICAgICAgICAgdGl0bGVzID0gc29ydGVkKFt2IGZvciB2IGluIG1hcHBlZF9kZlt0aXRsZV9jbl0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKQogICAgICAgICAgICBzZWxlY3RlZF90aXRsZXMgPSBzdC5tdWx0aXNlbGVjdCgi5oyJ6IGM56ew562b6YCJ77yI5Y+v5aSa6YCJ77yM55WZ56m65Li65YWo6YOo77yJIiwgdGl0bGVzKQoKICAgICAgICBmaWx0ZXJlZF9kZiA9IG1hcHBlZF9kZi5jb3B5KCkKICAgICAgICBpZiBzZWxlY3RlZF9tYWpvcnM6CiAgICAgICAgICAgIGZpbHRlcmVkX2RmID0gZmlsdGVyZWRfZGZbZmlsdGVyZWRfZGZbbWFqb3JfY25dLmlzaW4oc2VsZWN0ZWRfbWFqb3JzKV0KICAgICAgICBpZiBzZWxlY3RlZF90aXRsZXM6CiAgICAgICAgICAgIGZpbHRlcmVkX2RmID0gZmlsdGVyZWRfZGZbZmlsdGVyZWRfZGZbdGl0bGVfY25dLmlzaW4oc2VsZWN0ZWRfdGl0bGVzKV0KCiAgICAgICAgc3QuY2FwdGlvbihmIuetm+mAieWQjuWFseaciSB7ZmlsdGVyZWRfZGYuc2hhcGVbMF19IOadoeiusOW9leOAgiIpCgogICAgICAgIHN0LnN1YmhlYWRlcigi6ZqP5py65oq95qC3IikKICAgICAgICBtb2RlID0gc3QucmFkaW8oIuaKveagt+aWueW8jyIsIG9wdGlvbnM9WyLmjInmlbDph48iLCAi5oyJ55m+5YiG5q+UIl0sIGhvcml6b250YWw9VHJ1ZSwga2V5PSJzaW1wbGVfbW9kZSIpCiAgICAgICAgY29sMSwgY29sMiwgY29sMyA9IHN0LmNvbHVtbnMoMykKICAgICAgICB3aXRoIGNvbDE6CiAgICAgICAgICAgIHNlZWQgPSBzdC50ZXh0X2lucHV0KCLpmo/mnLrnp43lrZDvvIjlj6/pgInvvIznlZnnqbrliJnmr4/mrKHkuI3lkIzvvIkiLCB2YWx1ZT0iIikKICAgICAgICB3aXRoIGNvbDI6CiAgICAgICAgICAgIGNvdW50ID0gc3QubnVtYmVyX2lucHV0KCLmir3lj5bmlbDph48iLCBtaW5fdmFsdWU9MCwgdmFsdWU9MTAsIHN0ZXA9MSkKICAgICAgICB3aXRoIGNvbDM6CiAgICAgICAgICAgIHBlcmNlbnQgPSBzdC5zbGlkZXIoIuaKveWPlueZvuWIhuavlCIsIG1pbl92YWx1ZT0xLCBtYXhfdmFsdWU9MTAwLCB2YWx1ZT0yMCwgc3RlcD0xKQoKICAgICAgICBzYW1wbGVfc2l6ZSA9IGNvbXB1dGVfc2FtcGxlX3NpemUoCiAgICAgICAgICAgIHRvdGFsPWZpbHRlcmVkX2RmLnNoYXBlWzBdLCBtb2RlPW1vZGUsIGNvdW50PWludChjb3VudCksIHBlcmNlbnQ9ZmxvYXQocGVyY2VudCkKICAgICAgICApCiAgICAgICAgc3QuY2FwdGlvbihmIuWwhuaKveWPliB7c2FtcGxlX3NpemV9IOadoeiusOW9leOAgiIpCgogICAgICAgIGlmIHN0LmJ1dHRvbigi5byA5aeL5oq95qC3IiwgdHlwZT0icHJpbWFyeSIsIGtleT0ic2ltcGxlX2RvX3NhbXBsZSIpOgogICAgICAgICAgICBzYW1wbGVkID0gc2FtcGxlX3Jvd3MoZmlsdGVyZWRfZGYsIHNhbXBsZV9zaXplLCBzZWVkIGlmIHNlZWQgIT0gIiIgZWxzZSBOb25lKQogICAgICAgICAgICBzdC5zdWNjZXNzKGYi5oq95qC35a6M5oiQ77yM5YWxIHtzYW1wbGVkLnNoYXBlWzBdfSDmnaHjgIIiKQogICAgICAgICAgICBzdC5kYXRhZnJhbWUoc2FtcGxlZCwgdXNlX2NvbnRhaW5lcl93aWR0aD1UcnVlKQoKICAgICAgICAgICAgIyDkuIvovb0KICAgICAgICAgICAgY3N2X2J5dGVzID0gc2FtcGxlZC50b19jc3YoaW5kZXg9RmFsc2UpLmVuY29kZSgidXRmLTgtc2lnIikKICAgICAgICAgICAgZXhjZWxfYnl0ZXMgPSB0b19leGNlbF9ieXRlcyhzYW1wbGVkKQogICAgICAgICAgICBkbF9jb2wxLCBkbF9jb2wyID0gc3QuY29sdW1ucygyKQogICAgICAgICAgICB3aXRoIGRsX2NvbDE6CiAgICAgICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oCiAgICAgICAgICAgICAgICAgICAgbGFiZWw9IuS4i+i9vSBDU1YiLAogICAgICAgICAgICAgICAgICAgIGRhdGE9Y3N2X2J5dGVzLAogICAgICAgICAgICAgICAgICAgIGZpbGVfbmFtZT0i5oq95qC35ZCN5Y2VLmNzdiIsCiAgICAgICAgICAgICAgICAgICAgbWltZT0idGV4dC9jc3YiLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB3aXRoIGRsX2NvbDI6CiAgICAgICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oCiAgICAgICAgICAgICAgICAgICAgbGFiZWw9IuS4i+i9vSBFeGNlbCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YT1leGNlbF9ieXRlcywKICAgICAgICAgICAgICAgICAgICBmaWxlX25hbWU9IuaKveagt+WQjeWNlS54bHN4IiwKICAgICAgICAgICAgICAgICAgICBtaW1lPSgKICAgICAgICAgICAgICAgICAgICAgICAgImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0IgogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICApCgogICAgIyAtLS0tLS0tLS0tIOS7v+WItuaooeW8jygxOjEpIC0tLS0tLS0tLS0KICAgIHdpdGggdGFiX2Nsb25lOgogICAgICAgIHN0LnN1YmhlYWRlcigi6aG555uuIikKICAgICAgICBjb2xfYSwgY29sX2IsIGNvbF9jID0gc3QuY29sdW1ucyhbMS4yLCAxLjIsIDFdKQogICAgICAgIHdpdGggY29sX2E6CiAgICAgICAgICAgIHByb2pfbmFtZSA9IHN0LnRleHRfaW5wdXQoIumhueebruWQjeensCIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggY29sX2I6CiAgICAgICAgICAgIGJpZF9ubyA9IHN0LnRleHRfaW5wdXQoIuaLm+agh+e8luWPtyIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggY29sX2M6CiAgICAgICAgICAgIGRyYXdfdGltZSA9IHN0LnRleHRfaW5wdXQoIuaKveWPluaXtumXtCIsIHZhbHVlPWRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlWS0lbS0lZCAlSDolTTolUyIpKQoKICAgICAgICBzdC5zdWJoZWFkZXIoIuaKveWPluadoeS7tiIpCiAgICAgICAgYzEsIGMyLCBjMywgYzQgPSBzdC5jb2x1bW5zKDQpCiAgICAgICAgbWFqb3JfY24gPSBSRVFVSVJFRF9GSUVMRFNfQ05bIm1ham9yIl0KICAgICAgICB0aXRsZV9jbiA9IFJFUVVJUkVEX0ZJRUxEU19DTlsidGl0bGUiXQoKICAgICAgICB3aXRoIGMxOgogICAgICAgICAgICBtYWpvcl9vcHRzID0gc29ydGVkKFt2IGZvciB2IGluIGRmW21ham9yX2NuXS5kcm9wbmEoKS51bmlxdWUoKSBpZiBzdHIodikuc3RyaXAoKSAhPSAiIl0pIGlmIG1ham9yX2NuIGluIGRmLmNvbHVtbnMgZWxzZSBbXQogICAgICAgICAgICBtYWpvcl9zZWwgPSBzdC5tdWx0aXNlbGVjdCgi5LiT5LiaIiwgbWFqb3Jfb3B0cywga2V5PSJjbG9uZV9tYWpvciIpCiAgICAgICAgd2l0aCBjMjoKICAgICAgICAgICAgdGl0bGVfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZlt0aXRsZV9jbl0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiB0aXRsZV9jbiBpbiBkZi5jb2x1bW5zIGVsc2UgW10KICAgICAgICAgICAgdGl0bGVfc2VsID0gc3QubXVsdGlzZWxlY3QoIuiBjOensCIsIHRpdGxlX29wdHMsIGtleT0iY2xvbmVfdGl0bGUiKQogICAgICAgIHdpdGggYzM6CiAgICAgICAgICAgIGdlbmRlcl9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgiZ2VuZGVyIikKICAgICAgICAgICAgZ2VuZGVyX29wdHMgPSBzb3J0ZWQoW3YgZm9yIHYgaW4gZGZbZ2VuZGVyX2NvbF0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiBnZW5kZXJfY29sIGVsc2UgW10KICAgICAgICAgICAgZ2VuZGVyX3NlbCA9IHN0LnNlbGVjdGJveCgi5oCn5YirIiwgWyLlhajpg6giXSArIGdlbmRlcl9vcHRzIGlmIGdlbmRlcl9vcHRzIGVsc2UgWyLlhajpg6giXSwgaW5kZXg9MCkKICAgICAgICB3aXRoIGM0OgogICAgICAgICAgICBiaXJ0aF9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgiYmlydGgiKQogICAgICAgICAgICBpZiBiaXJ0aF9jb2w6CiAgICAgICAgICAgICAgICBhZ2VzID0gY29tcHV0ZV9hZ2Vfc2VyaWVzKGRmW2JpcnRoX2NvbF0pCiAgICAgICAgICAgICAgICBtaW5fYWdlID0gaW50KGFnZXMubWluKCkpIGlmIGFnZXMubm90bmEoKS5hbnkoKSBlbHNlIDE4CiAgICAgICAgICAgICAgICBtYXhfYWdlID0gaW50KGFnZXMubWF4KCkpIGlmIGFnZXMubm90bmEoKS5hbnkoKSBlbHNlIDgwCiAgICAgICAgICAgICAgICBhZ2VfcmFuZ2UgPSBzdC5zbGlkZXIoIuW5tOm+hCIsIG1pbl92YWx1ZT1tYXgoMTYsIG1pbl9hZ2UpLCBtYXhfdmFsdWU9bWluKDEwMCwgbWF4X2FnZSksIHZhbHVlPShtYXgoMTgsIG1pbl9hZ2UpLCBtaW4oNjUsIG1heF9hZ2UpKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN0LndyaXRlKCLlubTpvoTvvJrml6Dlh7rnlJ/lubTmnIjvvIzml6Dms5XnrZvpgIkiKQogICAgICAgICAgICAgICAgYWdlX3JhbmdlID0gTm9uZQoKICAgICAgICBjNSwgYzYsIGM3LCBjOCA9IHN0LmNvbHVtbnMoNCkKICAgICAgICB3aXRoIGM1OgogICAgICAgICAgICBkZWdyZWVfY29sID0gb3B0aW9uYWxfY29scy5nZXQoImRlZ3JlZSIpCiAgICAgICAgICAgIGRlZ3JlZV9vcHRzID0gc29ydGVkKFt2IGZvciB2IGluIGRmW2RlZ3JlZV9jb2xdLmRyb3BuYSgpLnVuaXF1ZSgpIGlmIHN0cih2KS5zdHJpcCgpICE9ICIiXSkgaWYgZGVncmVlX2NvbCBlbHNlIFtdCiAgICAgICAgICAgIGRlZ3JlZV9zZWwgPSBzdC5zZWxlY3Rib3goIuWtpuWOhiIsIFsi5YWo6YOoIl0gKyBkZWdyZWVfb3B0cyBpZiBkZWdyZWVfb3B0cyBlbHNlIFsi5YWo6YOoIl0sIGluZGV4PTApCiAgICAgICAgd2l0aCBjNjoKICAgICAgICAgICAgcXVhbF9jb2wgPSBvcHRpb25hbF9jb2xzLmdldCgicXVhbGlmaWNhdGlvbiIpCiAgICAgICAgICAgIHF1YWxfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZltxdWFsX2NvbF0uZHJvcG5hKCkudW5pcXVlKCkgaWYgc3RyKHYpLnN0cmlwKCkgIT0gIiJdKSBpZiBxdWFsX2NvbCBlbHNlIFtdCiAgICAgICAgICAgIHF1YWxfc2VsID0gc3Quc2VsZWN0Ym94KCLms6jlhozotYTmoLwiLCBbIuWFqOmDqCJdICsgcXVhbF9vcHRzIGlmIHF1YWxfb3B0cyBlbHNlIFsi5YWo6YOoIl0sIGluZGV4PTApCiAgICAgICAgd2l0aCBjNzoKICAgICAgICAgICAgb3JnX2NvbCA9IG9wdGlvbmFsX2NvbHMuZ2V0KCJvcmciKQogICAgICAgICAgICBvcmdfb3B0cyA9IHNvcnRlZChbdiBmb3IgdiBpbiBkZltvcmdfY29sXS5kcm9wbmEoKS51bmlxdWUoKSBpZiBzdHIodikuc3RyaXAoKSAhPSAiIl0pIGlmIG9yZ19jb2wgZWxzZSBbXQogICAgICAgICAgICBvcmdfc2VsID0gc3QudGV4dF9pbnB1dCgi5bel5L2c5Y2V5L2NIOWMheWQq+WFs+mUruivjSIsIHZhbHVlPSIiKQogICAgICAgIHdpdGggYzg6CiAgICAgICAgICAgIG51bV9wZW9wbGUgPSBzdC5udW1iZXJfaW5wdXQoIuS6uuaVsCIsIG1pbl92YWx1ZT0wLCB2YWx1ZT0xMCwgc3RlcD0xKQoKICAgICAgICAjIOWfuuS6juadoeS7tui/h+a7pAogICAgICAgIGNsb25lX2ZpbHRlcmVkID0gZGYuY29weSgpCiAgICAgICAgaWYgbWFqb3JfY24gaW4gY2xvbmVfZmlsdGVyZWQuY29sdW1ucyBhbmQgbWFqb3Jfc2VsOgogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW21ham9yX2NuXS5pc2luKG1ham9yX3NlbCldCiAgICAgICAgaWYgdGl0bGVfY24gaW4gY2xvbmVfZmlsdGVyZWQuY29sdW1ucyBhbmQgdGl0bGVfc2VsOgogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW3RpdGxlX2NuXS5pc2luKHRpdGxlX3NlbCldCiAgICAgICAgaWYgZ2VuZGVyX2NvbCBhbmQgZ2VuZGVyX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtnZW5kZXJfY29sXSA9PSBnZW5kZXJfc2VsXQogICAgICAgIGlmIGJpcnRoX2NvbCBhbmQgYWdlX3JhbmdlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhZ2VzID0gY29tcHV0ZV9hZ2Vfc2VyaWVzKGNsb25lX2ZpbHRlcmVkW2JpcnRoX2NvbF0pCiAgICAgICAgICAgIGNsb25lX2ZpbHRlcmVkID0gY2xvbmVfZmlsdGVyZWRbKGFnZXMgPj0gYWdlX3JhbmdlWzBdKSAmIChhZ2VzIDw9IGFnZV9yYW5nZVsxXSldCiAgICAgICAgaWYgZGVncmVlX2NvbCBhbmQgZGVncmVlX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtkZWdyZWVfY29sXSA9PSBkZWdyZWVfc2VsXQogICAgICAgIGlmIHF1YWxfY29sIGFuZCBxdWFsX3NlbCAhPSAi5YWo6YOoIjoKICAgICAgICAgICAgY2xvbmVfZmlsdGVyZWQgPSBjbG9uZV9maWx0ZXJlZFtjbG9uZV9maWx0ZXJlZFtxdWFsX2NvbF0gPT0gcXVhbF9zZWxdCiAgICAgICAgaWYgb3JnX2NvbCBhbmQgb3JnX3NlbC5zdHJpcCgpICE9ICIiOgogICAgICAgICAgICBrdyA9IG9yZ19zZWwuc3RyaXAoKQogICAgICAgICAgICBjbG9uZV9maWx0ZXJlZCA9IGNsb25lX2ZpbHRlcmVkW2Nsb25lX2ZpbHRlcmVkW29yZ19jb2xdLmFzdHlwZShzdHIpLnN0ci5jb250YWlucyhrdywgbmE9RmFsc2UpXQoKICAgICAgICBzdC5jYXB0aW9uKGYi56ym5ZCI5p2h5Lu26K6w5b2V77yae2Nsb25lX2ZpbHRlcmVkLnNoYXBlWzBdfSDkuroiKQoKICAgICAgICAjIOaKveWPli/miZPljbDmjInpkq4KICAgICAgICBidG5fY29sMSwgYnRuX2NvbDIgPSBzdC5jb2x1bW5zKFsxLCAxXSkKICAgICAgICBkb19kcmF3ID0gYnRuX2NvbDEuYnV0dG9uKCLmir3lj5YiLCB0eXBlPSJwcmltYXJ5Iiwga2V5PSJjbG9uZV9kcmF3IikKICAgICAgICBkb19wcmludCA9IGJ0bl9jb2wyLmJ1dHRvbigi5omT5Y2wIiwga2V5PSJjbG9uZV9wcmludCIpCgogICAgICAgIHNlbGVjdGVkID0gcGQuRGF0YUZyYW1lKCkKICAgICAgICBpZiBkb19kcmF3OgogICAgICAgICAgICBzZWxlY3RlZCA9IHNhbXBsZV9yb3dzKGNsb25lX2ZpbHRlcmVkLCBpbnQobnVtX3Blb3BsZSksIHNlZWQ9Tm9uZSkKICAgICAgICAgICAgc3Quc3VjY2VzcyhmIuW3suaKveWPliB7c2VsZWN0ZWQuc2hhcGVbMF19IOS6uuOAgiIpCiAgICAgICAgICAgICMg5bGV56S65LiO5LiL6L2977yI5L2/55So5Z+65pys5LqU5a2X5q6177yM5aaC5pyJ5Y+v6YCJ5a2X5q615YiZ6L+95Yqg5bGV56S677yJCiAgICAgICAgICAgIGJhc2VfY29scyA9IFsKICAgICAgICAgICAgICAgIFJFUVVJUkVEX0ZJRUxEU19DTlsibmFtZSJdLAogICAgICAgICAgICAgICAgbWFqb3JfY24gaWYgbWFqb3JfY24gaW4gc2VsZWN0ZWQuY29sdW1ucyBlbHNlIE5vbmUsCiAgICAgICAgICAgICAgICBSRVFVSVJFRF9GSUVMRFNfQ05bInBob25lIl0sCiAgICAgICAgICAgICAgICB0aXRsZV9jbiBpZiB0aXRsZV9jbiBpbiBzZWxlY3RlZC5jb2x1bW5zIGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgIFJFUVVJUkVEX0ZJRUxEU19DTlsiZW1haWwiXSwKICAgICAgICAgICAgXQogICAgICAgICAgICBiYXNlX2NvbHMgPSBbYyBmb3IgYyBpbiBiYXNlX2NvbHMgaWYgYyBhbmQgYyBpbiBzZWxlY3RlZC5jb2x1bW5zXQogICAgICAgICAgICBzaG93X2NvbHMgPSBiYXNlX2NvbHMuY29weSgpCiAgICAgICAgICAgIGZvciBvcHRfa2V5IGluIFsiZ2VuZGVyIiwgImJpcnRoIiwgIm9yZyIsICJwb3NpdGlvbiIsICJxdWFsaWZpY2F0aW9uIl06CiAgICAgICAgICAgICAgICBjb2wgPSBvcHRpb25hbF9jb2xzLmdldChvcHRfa2V5KQogICAgICAgICAgICAgICAgaWYgY29sIGFuZCBjb2wgaW4gc2VsZWN0ZWQuY29sdW1uczoKICAgICAgICAgICAgICAgICAgICBzaG93X2NvbHMuYXBwZW5kKGNvbCkKICAgICAgICAgICAgc3QuZGF0YWZyYW1lKHNlbGVjdGVkW3Nob3dfY29sc10gaWYgc2hvd19jb2xzIGVsc2Ugc2VsZWN0ZWQsIHVzZV9jb250YWluZXJfd2lkdGg9VHJ1ZSkKCiAgICAgICAgICAgICMg5LiL6L29CiAgICAgICAgICAgIGNzdl9ieXRlcyA9IChzZWxlY3RlZFtzaG93X2NvbHNdIGlmIHNob3dfY29scyBlbHNlIHNlbGVjdGVkKS50b19jc3YoaW5kZXg9RmFsc2UpLmVuY29kZSgidXRmLTgtc2lnIikKICAgICAgICAgICAgZXhjZWxfYnl0ZXMgPSB0b19leGNlbF9ieXRlcyhzZWxlY3RlZFtzaG93X2NvbHNdIGlmIHNob3dfY29scyBlbHNlIHNlbGVjdGVkKQogICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oIuS4i+i9vSBDU1YiLCBkYXRhPWNzdl9ieXRlcywgZmlsZV9uYW1lPSLmir3lj5bnu5PmnpwuY3N2IiwgbWltZT0idGV4dC9jc3YiKQogICAgICAgICAgICBzdC5kb3dubG9hZF9idXR0b24oIuS4i+i9vSBFeGNlbCIsIGRhdGE9ZXhjZWxfYnl0ZXMsIGZpbGVfbmFtZT0i5oq95Y+W57uT5p6cLnhsc3giLCBtaW1lPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCIpCgogICAgICAgICMg5omT5Y2w77yI55Sf5oiQ566A5rSBSFRNTOW5tuinpuWPkea1j+iniOWZqOaJk+WNsO+8iQogICAgICAgIGlmIGRvX3ByaW50OgogICAgICAgICAgICBwcmV2aWV3ID0gY2xvbmVfZmlsdGVyZWQuaGVhZCgyMDApICAjIOaJk+WNsOWJjemihOiniOS4gOmDqOWIhgogICAgICAgICAgICBodG1sX3RhYmxlID0gcHJldmlldy50b19odG1sKGluZGV4PUZhbHNlKQogICAgICAgICAgICBzdF9odG1sKAogICAgICAgICAgICAgICAgZiIiIgogICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgPHN0eWxlPgogICAgICAgICAgICAgICAgICAgIHRhYmxlIHt7Ym9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsgd2lkdGg6IDEwMCU7IGZvbnQtc2l6ZTogMTJweDt9fQogICAgICAgICAgICAgICAgICAgIHRoLCB0ZCB7e2JvcmRlcjogMXB4IHNvbGlkICM5OTk7IHBhZGRpbmc6IDZweDt9fQogICAgICAgICAgICAgICAgICA8L3N0eWxlPgogICAgICAgICAgICAgICAgICB7aHRtbF90YWJsZX0KICAgICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJpbnQoKTsKICAgICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICIiIiwKICAgICAgICAgICAgICAgIGhlaWdodD01MDAsCiAgICAgICAgICAgICkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgbWFpbigpCg==":
        code_bytes = base64.b64decode(APP_CODE_B64.encode("utf-8"))
        temp_dir = tempfile.mkdtemp(prefix="expert_sampler_")
        app_path = os.path.join(temp_dir, "app.py")
        with open(app_path, "wb") as f:
            f.write(code_bytes)
        return app_path

    # 兜底：若未替换Base64，则尝试查找同目录 app.py
    here = Path(getattr(sys, "_MEIPASS", Path(__file__).parent))
    candidate = here / "app.py"
    if candidate.exists():
        return str(candidate)
    raise RuntimeError("app.py 不存在，且未提供内嵌代码。")


def main() -> None:
    app_path = write_app_to_temp()
    try:
        # 直接使用 Streamlit 内部引导，避免依赖外部 CLI
        from streamlit.web import bootstrap
        bootstrap.run(app_path, "", [], {})
    except Exception:
        # 兜底：使用子进程方式
        import subprocess
        subprocess.run([sys.executable, "-m", "streamlit", "run", app_path], check=True)


if __name__ == "__main__":
    main()
